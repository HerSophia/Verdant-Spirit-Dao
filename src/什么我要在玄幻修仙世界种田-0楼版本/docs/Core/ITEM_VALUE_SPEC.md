# 物品价值体系规范 (ITEM_VALUE_SPEC.md) v1.1

本文档旨在为《玄幻修仙世界种田》项目设计一套完整、动态且可扩展的物品价值体系。该体系将作为“以物换物”等经济系统的核心基础，并与图鉴、事件和LLM叙事深度整合。

## 1. 设计哲学

1.  **多维价值 (Multi-dimensional Value)**: 物品的价值不应是单一的静态数字，而是由其**品阶、功用、稀有度**和**叙事重要性**共同决定的综合体现。
2.  **权威数据源 (Authoritative Source)**: 物品的**基础价值属性**应作为权威数据，存储在全局图鉴 (`pokedex-data.ts`) 中，确保世界观的一致性。
3.  **动态浮动 (Dynamic Fluctuation)**: 物品的**最终交易价值**应受游戏内事件（如传闻、任务需求）影响，在一个基础范围内动态浮动，创造一个更真实的经济环境。
4.  **LLM驱动的感知 (LLM-driven Perception)**: LLM在扮演NPC（如商人）时，应能**理解并运用**这套价值体系，根据物品的综合价值，在对话中表现出不同的态度和议价策略，而非简单地执行数值交换。

## 2. 核心数据结构扩展

为了实现该体系，我们需要对现有的核心数据结构进行扩展。

### 2.1 核心物品数据结构 (`pokedex-data.ts` & 角色变量)

物品的价值信息存在于两个地方：全局图鉴作为权威数据源，以及角色物品列表作为实例数据。

**1. 全局图鉴 (`pokedex-data.ts`)**

我们将为 `PokedexItem` 接口（或类似结构）添加一个新的 `价值` 对象。这是物品价值的**权威定义**。

```typescript
// 位于 pokedex-data.ts 或相关类型定义文件中
interface PokedexItem {
  名称: string;
  品阶: string;
  描述: string;
  // ... 其他已有字段 ...

  // [新增] 价值体系核心定义
  价值?: {
    基础价值: number; // 用于交易的核心基准值
    价值标签: string[]; // 描述其核心价值维度的标签
  };
}

// 示例
const 灵谷: PokedexItem = {
  名称: "灵谷",
  品阶: "凡品上阶",
  描述: "提供蕴含微弱灵气的食物。",
  价值: {
    基础价值: 10,
    价值标签: ["消耗品", "食物", "修炼材料_初期"]
  }
};

const 潮汐木芯: PokedexItem = {
  名称: "潮汐木芯",
  品阶: "凡品中阶",
  描述: "被海水长期冲刷的灵木核心，质地坚硬，防腐防潮。",
  价值: {
    基础价值: 5,
    价值标签: ["建筑材料", "防潮"]
  }
};
```

*   **`基础价值`**: 这个数值取代了之前在 `SYSTEMS_SPEC.md` 中临时定义的`价值`字段。它由品阶决定，作为所有计算的起点。
*   **`价值标签`**: 这是实现动态价值和LLM智能交互的关键。这些标签清晰地定义了物品的**功用维度**，例如：
    *   `消耗品`, `食物`, `药品`
    *   `建筑材料`, `炼器材料`, `炼丹材料`
    *   `修炼材料_初期`, `修炼材料_中期`
    *   `任务物品`, `剧情关键`
    *   `稀有`, `传说`, `唯一`

**2. 角色物品实例 (`角色.萧栖雪.物品`)**

角色物品列表中的每个物品对象，除了基础的 `名称` 和 `描述` 外，也**必须**包含 `价值` 对象，并可以有一个可选的 `数量` 字段。

```typescript
// 位于角色变量中的物品结构示例
interface CharacterItem {
  名称: string;
  描述: string;
  数量?: number; // 可选字段，如果缺失，系统默认为 1
  价值: {
    基础价值: number;
    价值标签: string[];
  };
}
```

*   **重要性**: 这个结构确保了即使一个物品尚未被收录进全局图鉴（例如，开局携带的特殊物品，或由事件动态生成的物品），它依然拥有一个明确的基础价值，可以在系统中流通。当需要计算其价值时，如果全局图鉴中找不到该物品，系统将使用此处的 `基础价值` 作为备用。
*   **数据来源**: 根据 `core/events/itemChangeHandler.ts` 的实现，当通过 `物品变化` 事件获得物品时，其所有数据（包括名称、描述、价值等）均直接来自事件的 `payload`。系统当前**不会**自动从全局图鉴进行数据校验或填充。

### 2.2 聊天变量 (`VARIABLES_SPEC.md`)

我们需要在 `世界` 命名空间下新增一个对象，用于管理动态的物品时价。

```json
// 位于 VARIABLES_SPEC.md 的 "世界" 命名空间下
世界: {
  // ... 其他已有变量 ...

  // [新增] 时价信息
  时价: {
    需求旺盛的标签: {
      "炼丹材料": 1.2, // 价值乘数
      "食物": 0.8      // 价值乘数
    },
    过期时间: 15 // 游戏天数，此行情在第15天后失效
  }
}
```

*   **`需求旺盛的标签`**: 这是一个字典，键是 `价值标签`，值是对应的价值乘数。这允许游戏通过事件（如“山野传闻”模块）来动态调整某一类物品的需求度。
*   **`过期时间`**: 确保时价是动态变化的，而不是永久性的。

**重要说明**: `时价` 是一个**后台机制**，其数据不应直接在任何玩家UI上显示。玩家应通过NPC的对话、传闻以及交易价格的浮动来感知时价的变化。

## 3. 价值计算逻辑

在任何需要计算物品交易价值的场景（如“以物换物”系统），都应遵循以下计算逻辑：

**`最终交易价值 = calculateItemValue(物品)`**

*   **`calculateItemValue` 函数**: 这是一个核心的价值计算函数，其内部逻辑如下：
    1.  **查找图鉴条目**: 尝试在全局图鉴 (`pokedex-data.ts`) 中根据 `物品.名称` 查找对应的条目。
    2.  **计算动态价值 (如果找到)**:
        *   获取图鉴条目中的 `基础价值`。
        *   调用 `getMarketModifier(图鉴条目.价值.价值标签)` 获取时价乘数。
        *   返回 `Math.round(基础价值 * 时价乘数)`。
    3.  **使用备用价值 (如果未找到)**:
        *   直接从物品对象本身获取 `物品.价值.基础价值`。
        *   返回该 `基础价值`。
    4.  **处理数量**: 在计算总价值时，将单个物品的 `最终交易价值` 乘以其 `数量` (如果 `数量` 字段不存在，则默认为 1)。

*   **`getMarketModifier` 函数**: 这是一个辅助函数，负责计算时价修正系数。
    1.  它会读取 `世界.时价`。
    2.  检查当前游戏天数是否超过了 `过期时间`。如果超过，则时价无效，返回 `1.0`。
    3.  遍历物品的 `价值标签`，如果在 `需求旺盛的标签` 中找到匹配项，则返回对应的乘数。
    4.  如果没有找到匹配项，返回 `1.0`。

## 4. LLM 交互与提示词设计

这是将整个系统“盘活”的关键。我们需要让LLM理解并运用这套体系。

### 4.1 在交易场景中的应用

当玩家与商人进行“以物换物”时，我们需要在发送给LLM的Prompt中，动态注入关于物品价值的“分析报告”。

**Prompt 增强 (`system_barter.md`)**:

```markdown
【背景】
你是一个精明的商人，对物品的价值有敏锐的洞察力。你不仅知道物品的基础价值，更了解它背后的真正用途和时价风闻。

【当前交易分析】
玩家想要用 {{玩家物品名称}} (数量: {{数量}}) 来交换 {{你的物品名称}}。

以下是我为你准备的内部价值分析报告：

1.  **关于 {{玩家物品名称}}**:
    *   **基础价值**: {{基础价值}}
    *   **核心功用**: {{价值标签}}
    *   **时价风闻**: {{时价风闻分析}}
    *   **综合评价**: {{综合评价}}

【你的任务】
根据以上分析，以你的身份和性格，与玩家进行一段有趣的对话。
*   如果玩家的物品价值远高于你的物品，你应该表现出欣喜，甚至愿意额外赠送一些添头。
*   如果价值相当，你可以正常交易。
*   如果玩家的物品价值较低，你应该表现出为难，并向他解释为什么这个交易不划算（例如，“这东西虽然基础价值还行，但眼下时价不高啊！”），并提出一个你认为公平的补充方案。
*   **不要**在对话中直接说出“基础价值”、“价值标签”等术语，要用一个商人的口吻把它们翻译成自然语言。
```

*   **动态注入内容**:
    *   `{{时价风闻分析}}`: 由代码根据 `世界.时价` 动态生成。例如：“最近炼丹大会临近，所有‘炼丹材料’都价格飞涨。”或“目前风平浪静，时价平稳。”
    *   `{{综合评价}}`: 由代码生成的一句总结。例如：“此物用途广泛，需求正旺，是硬通货。”或“此物较为偏门，只有特定人群需要。”

### 4.2 在创造新物品时的应用

当LLM通过叙事创造一个全新的物品时，我们需要引导它同时提出该物品的价值属性。

**Prompt 增强 (`base.md`)**:

在关于“新图鉴发现”事件的指令部分，增加以下内容：

> 如果你发现了一个全新的【物品】，在生成 `新图鉴发现` 事件时，请额外思考并包含以下内容：
>
> ```json
> {
>   "事件": "新图鉴发现",
>   "数据": {
>     "类别": "物品",
>     "条目": {
>       "名称": "...",
>       "品阶": "...", // 例如：凡品上阶
>       "描述": "...",
>       "价值": {
>         "基础价值": 15, // 根据品阶估算一个1-1000范围内的整数
>         "价值标签": ["标签1", "标签2"] // 从【价值标签列表】中选择最合适的1-3个标签
>       }
>     }
>   }
> }
> ```
>
> **【价值标签列表】**:
> `消耗品`, `食物`, `药品`, `建筑材料`, `炼器材料`, `炼丹材料`, `修炼材料_初期`, `修炼材料_中期`, `任务物品`, `剧情关键`, `稀有`, `传说`, `唯一`, `工具`, `书籍`, `知识`, `法器`, `奇物`

## 5. 实施步骤 (v1.1 更新)

1.  **创建本文档**: 在 `docs/` 目录下创建 `ITEM_VALUE_SPEC.md`。
2.  **修改 `VARIABLES_SPEC.md`**: 添加 `世界.时价` 部分。
3.  **修改 `POKEDEX_SPEC.md`**: 扩展物品定义，加入 `价值` 对象。
4.  **修改 `pokedex-data.ts`**: 为现有物品添加新的 `价值` 对象数据。
5.  **实现 `generateInitialMarketPrice`**: 在 `core/variables.ts` 中添加函数，用于在游戏开始时生成随机的 `世界.时价` 数据。
6.  **实现 `getMarketModifier` 和 `calculateItemValue`**: 在 `core/pokedex.ts` (或新的 `core/economy.ts`) 中实现这两个核心价值计算函数。
7.  **更新UI渲染逻辑**: 修改 `core/systems.ts` 中的 `renderBarterSystem` 函数，确保其能正确处理物品数量和备用价值逻辑，并正确计算总价值。
8.  **修改 `system_barter.md`**: 按照4.1节的设计，增强交易场景的Prompt。
9.  **修改 `base.md`**: 按照4.2节的设计，增强新物品发现的Prompt。
10. **更新事件处理器**: 更新 `pokedexDiscoveryHandler`，使其能处理和保存新物品的 `价值` 数据。
