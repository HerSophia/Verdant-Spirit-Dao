# 变量系统设计规范 (v2.0)

本文档旨在为《玄幻修仙世界种田》项目的变量系统提供一套清晰、统一的设计和使用规范，以确保数据流的稳定、可维护和可扩展性。

## 1. 设计哲学 (v1.1)

1. **单一事实来源 (Single Source of Truth)**: **聊天变量 (Chat Variables)** 是游戏持久化状态的唯一事实来源。所有模块都应优先读取聊天变量来获取当前状态。
2. **LLM作为事件生成器**: 大型语言模型（LLM）的核心职责是根据当前状态（由聊天变量提供）和用户输入，生成**叙事**和**状态变化事件**。LLM本身不应再负责维护和回传完整状态。
3. **事件驱动的状态更新**: LLM返回的状态栏JSON (`<statusbar>`) 只包含**事件**（如`物品变化`, `新成就`等）。`syncVariables` 模块负责解析这些事件，并将其精确地应用到作为“单一事实来源”的聊天变量上。
4. **渲染与逻辑分离**: 渲染器 (`renderer.ts`) 的核心职责是**读取**聊天变量并将其呈现在UI上。它不参与变量的写入。
5. **命名空间隔离**: 所有变量都必须归属于明确的命名空间下，主要分为 `角色` 和 `世界` 两大类，以避免全局污染和命名冲突。

## 2. 核心变量结构

所有变量都应遵循以下的结构组织。

### 2.1 `世界` 命名空间

此命名空间存放所有非角色绑定的、全局性的世界状态。

```json
世界: {
  时间: "穿越后第一日 · 夜晚",
  开局日期: { "年": 1, "月": 1, "日": 1 },
  当前日期: { "年": 1, "月": 1, "日": 1 },
  地点: "洄潮屿 · 庇护所",
  角色: {
    主控角色名: "萧栖雪",
    "萧栖雪": {
      姓名: "萧栖雪",
      种族: "人类 (异界来客)",
      职业: "岛屿建造者 / 灵植师",
      等级: "淬体境一层",
      状态: {
        口渴度: { value: 80, max: 100 },
        饱腹度: { value: 90, max: 100 },
        体力: { value: 75, max: 110 },
        灵力: { value: 0, max: 0 }
      },
      关系: {
        "李云": 20,
        "神秘商人": 0
      },
      物品: [
        {
          名称: "《长春诀》玉简",
          描述: "一部基础的木系修仙功法，能缓慢提升修为并滋养灵植。"
        },
        {
          名称: "太阳能充电器",
          描述: "来自故乡的奇特物品，能将光能转化为微弱电能。"
        }
      ]
    },
    "李云": {}
  },
  天气: {
    "当前天气": "晴朗",
    "天气描述": "万里无云，阳光普照。",
    "季节": "春",
    "节气": "惊蛰",
    "特殊天象": "无",
    "效果": ["阳光普照"]
  },

  庇护所: {
    "名称": "望海崖居",
    "规模": "石木混合结构", // 庇护所的整体规模，影响解锁的功能上限
    "状态": "稳固", // 整体状态，如“稳固”、“受损”、“废弃”
    "舒适度": "良好", // 影响玩家心情、修炼效率等
    "防御力": "坚固", // 影响抵御外部攻击的能力
    "功能": [ // 整体功能列表，由子系统提供
      "🔨 简易工作台",
      "🔥 石砌壁炉",
      "🛏️ 干草床铺"
    ],
    "组件": { // 庇护所的各个可升级/建造的组件
      "围墙": {
        "规模": "潦草",
        "材料": "木材",
        "耐久度": "完好无损",
        "防御加成": "微弱"
      },
      "屋顶": {
        "规模": "潦草",
        "材料": "茅草",
        "耐久度": "完好无损",
        "防雨加成": "轻微"
      },
      "农田": {
        "id": "farm_001",
        "规模": "未开垦",
        "状态": "未建造", // 或 "空闲", "种植中"
        "作物": null, // 当前种植的作物ID
        "产出效率": "普通" // 影响作物生长速度和产量
      },
      "药园": {
        "id": "herb_001",
        "规模": "未开垦",
        "状态": "未建造",
        "药材": null,
        "产出效率": "普通"
      },
      "防御阵法": {
        "规模": "未布置",
        "状态": "未激活", // 或 "激活中", "破损"
        "灵力消耗": "无",
        "防御加成": "无"
      }
    },
    "事件日志": [ // 记录庇护所发生的重大事件，如攻击、修复
      { "天数": 10, "类型": "攻击", "摘要": "遭受妖兽小股袭击，围墙轻微受损" },
      { "天数": 15, "类型": "升级", "摘要": "围墙升级至2级" }
    ]
  },

  // (vFuture 新增) 地图系统
  地图: {
    "regions": {
      "forest_01": {
        "region_id": "forest_01",
        "name": "宁静森林",
        "description": "一片静谧的古老森林，阳光透过茂密的树冠洒下斑驳的光影。",
        "status": "visited",
        "tags": ["forest", "safe", "resource_rich"],
        "properties": {
          "has_npc": true,
          "weather_influence": "calm"
        }
      }
    },
    "connections": [
      {
        "from_region": "forest_01",
        "to_region": "cave_01",
        "description": "一条蜿蜒的林间小路通向北方，深入山体的一个阴暗洞口。",
        "direction": "北方",
        "is_visible": true,
        "conditions": []
      }
    ],
    "currentPlayerLocation": "forest_01"
  },

  // 全局图鉴，是所有已发现事物的数据库
  图鉴: {
    妖兽: [
      {
        名称: "礁岩拟蟹",
        等级: "一阶下品",
        习性: "伪装成礁石，被动防御，甲壳坚硬。",
        掉落物: "蟹腿（可食用）、甲壳粉末（疗伤）"
      }
    ],
    植物: [
      {
        名称: "灵谷",
        品阶: "凡品上阶",
        功效: "提供蕴含微弱灵气的食物。"
      }
    ],
    物品: [
      {
        名称: "潮汐木芯",
        品阶: "凡品中阶",
        描述: "被海水长期冲刷的灵木核心，质地坚硬，防腐防潮。"
      }
    ],
    书籍: []
  },

  // --- 系统状态 (v2.1 优化) ---

  // 各系统的独立、持久化状态数据
  成就: {
    "成就点数": 10,
    "completed": {
      "achv_first_crab": {
        "id": "achv_first_crab",
        "名称": "蟹逅",
        "描述": "第一次击败（或赶跑）礁岩拟蟹。",
        "完成时间": "第一日·黄昏"
      }
    }
  },
  技能: {
    "skills": {
      "skill_water_1": {
        "id": "skill_water_1",
        "名称": "引水咒",
        "熟练度": 5,
        "等级": 1
      }
    }
  },
  签到: {
    "签到记录": {
      "Y1M1": [1, 5, 10, 28]
    },
    "连续签到天数": 5,
    "今日已签到": false,
    "月卡": {
      "状态": "未激活",
      "剩余天数": 0
    }
  },

  // 单独的、轻量级的“当前系统”视图控制器
  当前激活系统: {
    名称: "无" // 唯一职责：告诉UI现在该渲染哪个系统
  },

  // 动态任务列表
  任务列表: [
    {
      "id": "quest_001",
      "名称": "安身之所",
      "描述": "建立一个基础的庇护所，以度过漫漫长夜。",
      "状态": "进行中",
      "目标": [
        { "描述": "收集潮汐木芯 (5/10)", "完成": false },
        { "描述": "寻找一片平坦的空地", "完成": true }
      ],
      "奖励": "庇护所建造图纸 x1"
    }
  ],

  // (v2.0 新增) 市场行情
  市场行情: {
    需求旺盛的标签: {
      "炼丹材料": 1.2, // 价值乘数
      "食物": 0.8      // 价值乘数
    },
    过期时间: 15 // 游戏天数，此行情在第15天后失效
  },

  // (v2.0 新增) 事件日志：记录所有导致状态变更的事件
  事件列表: [
    {
      "eventId": "evt_1672531200_abc",
      "sourceMessageId": "msg_abc123xyz",
      "type": "物品变化",
      "payload": { "获得": [{ "名称": "灵谷", "数量": 5 }] }
    },
    {
      "eventId": "evt_1672531201_def",
      "sourceMessageId": "msg_def456yzw",
      "type": "物品变化",
      "payload": { 
        "更新": [
          {
            "名称": "太阳能充电器",
            "更新": { "描述": "来自故乡的奇特物品，能将光能转化为微弱电能。目前电量充足。", "电量": 100 }
          }
        ]
      }
    }
  ],

  // (v2.5 新增) 初始状态快照：记录游戏开局时的完整状态，用于事件溯源
  初始状态: {
    // ... 此处会深拷贝一份游戏开始时的完整 角色 和 世界 对象 ...
  },

  // (v2.6 新增) 状态快照列表：用于性能优化，存储特定时间点的完整游戏状态
  状态快照: {
    // "messageId": { ...完整的聊天变量深拷贝... }
    "msg_abc123": {
      "角色": { "...": "..." },
      "世界": { "...": "..." }
    }
  },

  // (vFuture 新增) 传送系统
  传送点: {
    "已解锁": ["洄潮屿"], // 玩家已解锁可传送的地点列表
    "当前激活": "洄潮屿" // 当前传送网络的激活点（未来可用于特殊玩法）
  },

  // (vFuture 新增) 知识库使用频率统计
  知识库使用统计: {
    // 键为图鉴条目的完整变量路径
    // "世界.图鉴.物品.潮汐木芯": {
    //   "frequency": 15, // 被引用的总次数
    //   "lastSentTurn": 102 // 上次被发送给LLM的回合数
    // }
  },

  // (vFuture 新增) 奇遇模块
  奇遇: {
    "冷却至天数": 95, // 下一次奇遇最早可以发生的【相对游戏天数】
    "上次奇遇日期": { "年": 1, "月": 1, "日": 20 }, // 上一次发生奇遇的【绝对游戏日期】
    "历史奇遇记录": [ // (可选) 用于未来分析或展示
      { "天数": 20, "类型": "discovery", "摘要": "发现古旧的羊皮纸残片" }
    ]
  },

  // (vFuture 新增) 手机系统
  手机: {
    "型号": "山海经-初代",
    "状态": "关机",
    "电量": {
      "当前值": 0,
      "最大值": 100,
      "充电方式": "未解锁"
    },
    "信号": {
      "当前强度": 0,
      "来源": "无"
    },
    "已解锁应用": [
      "设置",
      "时钟"
    ],
    "应用数据": {
      "相册": [],
      "便签": []
    }
  }
}
```

### 2.3 `plugin_storage` 命名空间

此命名空间用于存放由可插拔模块管理的、与核心游戏逻辑分离的持久化数据。

```json
plugin_storage: {
  // (vFuture 新增) 智能上下文链接器学习档案
  context_linker_profile: {
    // 键为图鉴条目的完整变量路径
    // "世界.图鉴.物品.潮汐木芯": {
    //   "dynamicKeywords": ["硬木头", "防潮材料"],
    //   "lastAnalyzedTurn": 102, // 上次被分析的回合数
    //   "missCount": 3 // 未命中（分析后未产生新关键词）的次数
    // }
  },

}
```

### 2.4 `备份` 命名空间 (v2.7 新增)

此命名空间用于存放核心数据的冗余备份，以增强存档的容错能力和可恢复性。

```json
备份: {
  // L3级缓存（初始状态）的冗余备份
  初始状态备份: {
    // ... 此处会深拷贝一份游戏开始时的完整 角色 和 世界 对象 ...
  }
}
```

## 3. 数据流转过程 (理想模型)

1. **游戏开局 (`main.ts`)**:
    * 玩家在开局界面进行选择。
    * 点击“确认开局”后，`main.ts` 负责将玩家的选择组装成符合规范的、完整的初始 `角色` 和 `世界` 变量结构。
    * 调用 `insertOrAssignVariables` 将这套初始变量**一次性写入**聊天变量，建立“单一事实来源”。
    * 同时，生成一份初始的、包含完整信息的状态栏JSON，用于驱动第一次渲染。

2. **发送请求 (Generation Logic)**:
    * 在向LLM发送请求前，从聊天变量中提取并格式化当前的游戏状态，以此作为“单一事实来源”。
    * 同时，加载完整的（或经过摘要的）聊天记录，并移除其中所有过时的状态栏信息以避免混淆。
    * 将【当前状态】作为一条置顶的系统消息，与【清理后的聊天记录】合并，共同构建成一个完整的上下文。
    * 向LLM发送用户输入和这个合并后的完整上下文，确保LLM既能获取最准确的当前状态，又能理解对话的连续性。

3. **接收与处理响应 (`renderer.ts` & `variables.ts`)**:
    * LLM返回包含**叙事**和**事件JSON** (`<statusbar>`) 的新消息。
    * `renderer.ts` 提取事件JSON。
    *   **变量同步**: 将事件JSON传递给 `syncVariables` (`variables.ts`)。`syncVariables` 的职责被进一步明确和简化：
        1.  **处理核心上下文**: 它只负责处理 `状态总览` 中的 `🗓️ 日期与时间` 和 `🏞️ 地点与环境`，直接更新 `世界.时间` 和 `世界.地点`。
        2.  **委托事件处理**: 它会将从LLM响应中解析出的 `事件列表` 数组**直接传递**给 `EventManager` 的 `processEvents` 方法。
    *   **事件持久化**: `EventManager` 在处理完每个事件后，除了更新对应的状态变量（如 `世界.任务列表`），还必须将该事件对象追加到 `世界.事件列表` 数组中，以实现事件溯源。
    * **UI渲染**: `renderer.ts` 中的所有渲染函数**只读取**更新后的聊天变量，并刷新整个UI界面。

### 3.1 事件对象契约

为了实现精确的状态追溯和管理，从LLM的`<statusbar>`中解析出的`事件列表`里的每一个事件对象，都必须遵循以下数据契约：

```json
{
  "eventId": "evt_1672531200000_randomstr", // 新增字段：事件的全局唯一ID
  "type": "物品变化", // 事件类型，例如 "物品变化", "新成就", "任务更新" 等
  "sourceMessageId": "msg_abc123xyz", // 此事件来源的LLM响应消息的唯一ID
  "payload": {
    // ... 事件的具体数据 ...
    "item": "灵谷",
    "change": 5
  }
}
```

* **`eventId` (string, required)**: 每个事件的全局唯一标识符（UUID）。这是为了确保即使在同一个消息中存在多个同类型事件，也能够对它们进行唯一区分。
* **`type` (string, required)**: 描述事件的类型。`syncVariables` 模块会根据此类型调用相应的处理器。
* **`sourceMessageId` (string, required)**: 这是一个至关重要的字段。它必须是生成此事件的LLM响应消息的唯一标识符 (`messageId`)。这使得我们能够将每一个状态变更精确地追溯到其源头。
* **`payload` (object, required)**: 包含该事件所需的所有具体数据。其结构由`type`决定。

这个`sourceMessageId`是实现“事件溯源与状态激活”机制的基石。

### 3.2 页面加载与Swipe切换时的状态恢复

当用户刷新页面或切换 `Swipe` 时，系统会执行一个精确的状态重算流程，以确保游戏无缝衔接：

1. **寻找快照**: `renderer.ts` (页面加载时) 或 `variables.ts` (切换 `Swipe` 时) 会从历史记录中找到目标消息。
2. **重放事件**: `recalculateStateFromEvents` 函数会被调用。它会从游戏的初始状态开始，重放截至目标消息的父消息的所有事件，然后再应用目标消息自身的事件。
3. **恢复状态**: 这个“事件重放”的过程，确保了聊天变量被精确地恢复到目标消息所对应的状态。
4. **渲染UI**: 最后，所有UI组件都根据已恢复的、作为“单一事实来源”的聊天变量来进行渲染。

这一机制确保了数据的持久性和一致性，是整个变量系统的核心健壮性保障。

## 4. 最佳实践

* **禁止直接修改**: 任何模块都不应绕过 `syncVariables` 的事件处理逻辑，直接用状态栏的原始数据覆盖聊天变量。
* **优先扩展**: 当需要添加新的全局状态时（例如“天气系统”），应优先在 `世界` 命名空间下扩展，而不是创建新的顶级变量。
* **数据驱动UI**: 所有UI的显示都必须由聊天变量驱动。避免在渲染逻辑中维护临时状态。
* **参考本文档**: 在进行任何涉及变量读写的功能开发前，请务必参考此文档，确保数据结构的一致性。
