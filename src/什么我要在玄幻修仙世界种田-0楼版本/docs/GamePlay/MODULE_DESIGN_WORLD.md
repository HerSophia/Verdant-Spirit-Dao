# 设计文档：动态世界观模块 (Dynamic Worldview Module)

## 1. 核心理念

本模块旨在将游戏的世界观从静态的背景设定，转变为一个与玩家互动、随游戏进程而动态演进的“活的”叙事系统。其核心理念是“逐步揭示，动态生长”，即世界的信息不是一次性灌输给玩家，而是在玩家的探索和行动中被逐步发现，同时世界自身也会基于游戏内事件生成新的内容。

这避免了开局时繁杂的背景信息轰炸，让玩家的每一次发现都充满意义，从而构建一个更具沉浸感和神秘感的游戏世界。

## 2. 世界观的构成元素

动态世界观主要由以下几种可扩展的叙事元素构成，它们被统一存储在 `worldStore` 中，但具有不同的状态（如“未发现”、“已揭示”、“已完成”）。

* **地图区域 (`regions`)**: 游戏世界的基础，玩家探索的物理空间。
* **传闻 (`rumors`)**: 关于世界历史、人物、地点或隐藏要素的零散信息。它们是引导玩家探索和串联剧情线索的主要载体。
* **图鉴条目 (`pokedex_entries`)**: 关于世界中特定动植物、矿物、物品的详细知识。玩家通过观察和互动来解锁这些知识。
* **奇遇线索 (`adventure_hooks`)**: 针对特定玩家行为或特质量身定制的、潜在的任务或事件的引子。

## 3. 世界观的生命周期

世界观的演进遵循一个三阶段的生命周期：**创生 -> 揭示 -> 演化**。

### 阶段一：世界创生 (Genesis)

此阶段在游戏开始时执行一次，为玩家生成一个独一无二的初始世界。

* **触发时机**: 玩家完成开局设置，点击“开始游戏”时。
* **实现机制**:
    1. 系统收集玩家的【核心世界观】和【玩家开局设定】。
    2. 调用在 `PROMPT_DESIGN_WORLD_GENERATION.md` 中定义的综合性Prompt，通过主LLM生成初始的世界数据。
    3. 输出结果为一个包含 `initial_map` 和 `worldview_details` 的JSON对象。
* **数据流**:
  * `initial_map` 的数据被注入到 `世界.地图` 变量中，由 `worldStore` 统一管理。`mapStore` 作为门面，从此状态派生数据。
  * `worldview_details`（包含传闻、图鉴、奇遇）中的所有条目被存入 `世界.世界观` 等相应的变量中，由 `worldStore` 统一管理，并被标记为初始状态 **`'undiscovered'`**。这些是世界的“叙事种子”，等待玩家去发现。

### 阶段二：逐步揭示 (Discovery)

此阶段是游戏的核心循环之一。玩家通过与世界的互动，将“未发现”的叙事元素转变为“已揭示”。

* **触发时机**: 贯穿整个游戏过程。
* **实现机制**:
  * **探索驱动**: 当玩家进入一个新区域或与特定环境互动时，LLM可以生成事件（如 `新图鉴发现`），由 `worldStore` 统一处理，从而将 `'undiscovered'` 元素的状态更新为“已揭示”。
  * **对话驱动**: 在与NPC进行闲聊时，系统会从 `worldStore` 中抽取合适的 `'undiscovered'` 传闻，动态地注入到NPC的对话Prompt中。当NPC说出该传闻后，LLM会生成一个事件来将该传闻的状态更新为 **`'known'`**。
  * **行为驱动**: 系统持续监听玩家的特定行为。当玩家的行为满足某个 `'undiscovered'` 奇遇线索的触发条件时，LLM可以生成一个 `奇遇` 事件，由 `worldStore` 处理后开启一段新的冒险。

### 阶段三：动态演化 (Evolution)

当游戏进行到一定阶段，或发生重大事件时，世界观自身也会“生长”出新的内容，确保世界始终对玩家保有新鲜感。

* **触发时机**: 游戏内的周期性事件（如季节更替、特定天数过去）或关键节点事件（如玩家完成某个重要目标）。
* **实现机制**:
  * 以 `rumorStore` 的后台传闻生成机制为代表。该机制由 `timeChanged` 事件触发。
  * 系统收集当前的**游戏状态**（如玩家已知信息、当前日期、世界状态等）作为上下文。
  * 使用**次级LLM API (`generateWithSecondaryApi`)** 在后台调用一个“世界演化”的专用Prompt，生成新的叙事元素（如新的传闻、因玩家行为而出现的新的生物等）。
  * 新生成的元素同样以 `'undiscovered'` 状态，通过LLM事件被添加入 `worldStore`，等待在未来的游戏中被玩家揭示。
* **优势**:
  * **性能**: 使用次级LLM API在后台处理，不阻塞主游戏线程。
  * **适应性**: 新生成的内容基于玩家当前的游戏状态，使得世界演化与玩家的经历息息相关，更具个性化。

## 4. 数据与状态管理

* **中心化存储**: 所有世界观的叙事元素（传闻、图鉴、奇遇）都应作为结构化数据存储在 `世界` 变量的相应命名空间下（如 `世界.世界观`, `世界.图鉴`），并由 `worldStore` 作为唯一事实来源进行管理。
* **状态追踪**: 每个叙事元素都必须有一个 `status` 字段来追踪其生命周期。状态的变更**必须**通过LLM事件驱动，由 `worldStore` 统一处理。
* **模块间通信**: 各个业务Store（如 `rumorStore`, `pokedexStore`）作为门面，通过 `computed` 属性从 `worldStore` 响应式地派生数据，供UI或其他模块使用。

通过以上设计，世界观不再是一个静态的设定集，而是一个贯穿游戏始终、与玩家共同成长的动态系统。
