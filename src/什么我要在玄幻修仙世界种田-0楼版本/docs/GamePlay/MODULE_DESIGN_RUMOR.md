# 模块设计文档：“山野传闻” - 动态世界事件模块

本文档旨在为“山野传闻”新模块设计详细、可靠的技术实现方案。

## 1. 核心目标

周期性地、在后台生成一些发生在玩家视野之外的背景事件或传闻。这些传闻可以增加世界的动态感和真实感，为玩家提供探索的线索，或者仅仅是作为丰富世界观的背景噪音。

## 2. 设计原则

同样遵循**非侵入式**、**异步处理**、**数据隔离** (`plugin_storage.rumors`) 和**关注点分离**的原则。

## 3. 技术方案构思

### 3.1. 传闻生成 (Rumor Generator)

**触发时机**:

* 传闻不应每天都生成，否则会信息过载。可以设计一个**周期性**加**概率性**的触发器。
* 例如：`timeChanged` 事件触发时，模块进行一次“传闻生成检定”，有20%的几率启动一次生成流程。这个概率可以受游戏内状态影响（如“天下大势”变量）。

**生成逻辑**:

1. **上下文收集**: 为了生成有意义的传闻，需要向LLM提供当前的世界状态。包括：
    * **世界信息**: 关键地点、势力、文化背景。
    * **NPC信息**: 重要的NPC列表、他们的性格、最近的动向。
    * **近期大事件**: 玩家最近完成的主线任务，对世界造成的影响。
2. **调用LLM生成传闻**:
    * 构建一个专门的Prompt，要求LLM基于以上上下文，生成一则或数则传闻。
    * Prompt可以引导传闻的类型，例如：“请生成一则关于[地点A]的怪异现象的传闻”或“请生成一则关于[NPC B]最近反常举动的传闻”。
    * 传闻内容应是模糊的、道听途说的口吻。

### 3.2. 传闻存储与管理 (Rumor Storage & Management)

**数据结构**:

* 每一条传闻都应是一个结构化对象，包含：
  * `id`: 唯一标识符。
  * `content`: 传闻的文本内容。
  * `source_location`: 传闻的“发源地”（例如，哪个城镇的人在讨论）。
  * `created_date`: 生成日期。
  * `expiry_date`: 过期日期（旧闻应该会消失）。
  * `status`: 传闻状态（如 `active`, `heard_by_player`, `expired`）。
  * `related_entities`: 传闻关联的实体（如NPC ID, 地点ID）。
  * `type`: 传闻的类型，在生成时由LLM决定。例如:
    * `'flavor'`: 纯粹的背景氛围，无实际影响。 (例：“听说王大婶家的猫又生了一窝。”)
    * `'lore'`: 涉及世界观或历史传说。 (例：“据说村子后面的青峰山镇压着一头古兽。”)
    * `'hook'`: 包含可行动的线索，有潜力发展为任务。(例：“最近总有人说深夜在废弃矿洞里听到怪声。”)

**存储**:

* 所有传闻都作为世界观的一部分，存储在 `世界.世界观.rumors` 数组中，并由 `worldStore` 统一管理。

### 3.3. 传闻注入与应用 (Rumor Injection & Application)

**核心问题**: 玩家如何得知这些传闻，并与之互动？

**注入方式**:

* **NPC闲聊 (主要方式)**:
  * **机制**: 增强与通用NPC（如“村民”、“守卫”）的对话逻辑。当玩家与他们闲聊时，模块会从 `plugin_storage.rumors` 中抽取一条状态为 `active` 的传闻，并将其作为闲聊内容注入到LLM的对话Prompt中。
  * **状态变更**: 一旦传闻被注入对话并展示给玩家，其 `status` 应变更为 `heard_by_player`。

**传闻的后续发展 (叙事驱动)**:

* **核心理念**: 传闻不直接等于任务。它是一个叙事引子，任务是玩家追寻线索的**结果**。
* **发展逻辑**:
    1. 当玩家听到一个 `type` 为 `'hook'` 的传闻后，系统并**不**会立即创建任务。
    2. 取而代之，系统会激活一个或多个“潜在发展点”。这可能是：
        * **新的对话选项**: 当玩家与传闻中 `related_entities` 相关的NPC（例如，村长）对话时，会出现一个新的、关于这个传闻的对话选项。
        * **新的场景交互**: 传闻中提到的地点（例如，废弃矿洞）可能会出现一个新的交互点（例如，“一堆可疑的脚印”）。
    3. **任务的诞生**: 只有当玩家主动选择这些新的对话选项，或调查了新的交互点，才会触发相应的事件，并最终在 `世界.任务列表` 中创建新任务。
* **玩家体验**: 这种设计让任务的发现过程变得非常有机。玩家会感觉是自己通过观察和打听发现了秘密，而不是系统在“喂”给他任务，从而极大地增强了沉浸感和探索的乐趣。
