# 模块设计文档：“岁月留痕” - 自动玩家日记模块

本文档旨在为“岁月留痕”新模块设计详细、可靠的技术实现方案。

## 1. 核心目标

在游戏内每一天结束时，根据当天发生的重要事件，以玩家的第一人称视角，自动生成一篇日记。这篇日记应能体现玩家当天的主要活动、情绪变化和关键进展。

## 2. 设计原则

*   **非侵入式**: 严格遵守“即插即用”原则，不修改核心游戏循环。
*   **异步处理**: 日记的生成过程应在后台异步执行，避免阻塞游戏主线程。
*   **数据隔离**: 日记数据和相关状态应存储在独立的命名空间下（例如 `plugin_storage.diary`）。
*   **关注点分离**: 将“信息收集”、“日记生成”和“日记展示”三个环节清晰地分离开。

## 3. 技术方案构思

### 3.1. 信息收集 (Data Collector)

**触发时机与逻辑**:
*   核心钩子是 `timeChanged(old_time, new_time)`。模块需要监听此事件，并计算新旧时间戳之间度过了多少天 (`days_passed`)。
*   **如果 `days_passed` == 1**: 触发标准的“每日日记”生成流程。
*   **如果 `days_passed` > 1**: 触发“时间跳跃总结”生成流程。
*   **如果 `days_passed` <= 0**: 不执行任何操作。

**收集内容**:
*   为了应对时间跳跃，我们需要一个更持久的“事件缓冲区”（`event_buffer`），而不仅仅是每日清空。
*   所有被监听的事件（如 `quest_started`）在存入缓冲区时，都需要附带上当前的**游戏内日期**。
*   我们需要监听一系列能反映玩家重要行为的事件，并将关键信息（包含日期）存入缓冲区。

**事件重要性评估 (Event Significance Assessment)**:
*   为了避免日记内容被琐事淹没，模块在接收到事件时，会根据一套预设规则为其评定一个重要性等级 (`significance`)。
*   **规则示例**:
    *   **高 (High)**: `quest_completed`, `player_state_changed` (如升级、领悟新技能), `favorability_changed` (关系突破或破裂)。
    *   **中 (Medium)**: `quest_started`, `quest_progressed`, `pokedex_discovered` (首次发现), `item_acquired` (稀有或剧情物品)。
    *   **低 (Low)**: `item_acquired` (普通物品), 常规交易。
*   这个评级将用于后续的摘要生成环节。

**收集的事件示例**:
    *   `quest_started(quest_id)`: 开始了新任务。
    *   `quest_progressed(quest_id, progress_description)`: 任务取得进展。
    *   `quest_completed(quest_id)`: 完成了任务。
    *   `pokedex_discovered(entry_id)`: 发现了新品种的灵植/灵兽。
    *   `item_acquired(item_id, quantity, source)`: 获得了重要物品。
    *   `favorability_changed(npc_id, change_amount, reason)`: 与NPC的好感度发生变化。
    *   `player_state_changed(state, description)`: 玩家状态改变（如受伤、升级）。

**数据结构**:
*   `event_buffer` 可以是一个数组，每个元素是一个包含 `date`, `event_type`, `event_data`, 以及 `significance` ('High' | 'Medium' | 'Low') 的对象。

### 3.2. 日记生成 (Diary Generator)

**触发时机**:
*   由 `timeChanged` 事件根据上一节描述的逻辑（判断 `days_passed`）来触发。整个生成过程应异步执行。

**核心流程 (标准每日日记)**:
1.  **信息汇总**: 从 `event_buffer` 中提取出**刚刚过去的那一天**的所有事件记录。
2.  **摘要与提炼**:
    *   **问题**: 直接将所有事件喂给LLM可能成本高且效果不佳。
    *   **方案**: 设计一个**预处理/摘要模块**。该模块会根据事件的 `significance` 等级来构建“今日摘要”。
    *   **处理逻辑**:
        *   优先详细描述所有“高”重要性事件。
        *   其次，概括性地提及“中”重要性事件。
        *   “低”重要性事件可以被忽略，或者合并成一句话（例如“...并采集了一些常见的草药。”）。
    *   **输出示例**:
        > "今天，我接下了寻找‘七星草’的任务（中），并且在后山有了初步的发现（中）。我还遇到了一个新的灵兽‘火光兔’（中），并和张三师傅的好感度提升了（高）。"
3.  **调用LLM生成日记**:
    *   构建一个专门的Prompt，包含以下部分：
        *   **角色设定**: “你是我，请以我的口吻和性格写一篇日记。”
        *   **上下文信息**: 玩家的核心人设、当前的主要目标等。
        *   **今日摘要**: 上一步生成的摘要文本。
        *   **格式要求**: 要求生成日记的格式、长度和语气。
    *   使用一个成本较低、速度较快的LLM模型进行生成。
4.  **数据持久化**:
    *   将生成的日记内容，连同日期信息，存储到 `plugin_storage.diary.entries` 中。
    *   **清理缓冲区**: 将已用于生成日记的事件从 `event_buffer` 中清除，以防重复处理。

**核心流程 (时间跳跃总结)**:
1.  **信息汇总**: 从 `event_buffer` 中提取出在**整个时间跳跃期间**发生的所有事件记录。
2.  **摘要与提炼**: 将这段时间内的所有事件，融合成一个更宏观的摘要。例如：“在过去的七天里，我专注于炼丹，成功炼制了三枚‘筑基丹’，但也因此错过了村里的春日祭典。”
3.  **调用LLM生成总结**:
    *   使用一个专门为“时间跳跃”场景设计的Prompt。
    *   这个Prompt会要求LLM生成一篇回顾式的、总结性的日记条目，而不是每日流水账。
4.  **数据持久化与清理**:
    *   将生成的总结性日记，标记为对应时间段（如“第十天 至 第十六天”），存入 `plugin_storage.diary.entries`。
    *   同样，清理 `event_buffer` 中已被处理的事件。

### 3.3. 日记展示 (Diary UI)

**触发时机**:
*   玩家通过游戏内的某个UI入口（例如，床头的“日记本”按钮）主动触发。

**实现方式**:
*   创建一个新的UI模态框（Modal）。
*   当玩家打开时，从 `plugin_storage.diary.entries` 读取所有已生成的日记。
*   以合适的格式（例如，按日期倒序排列）展示给玩家。
