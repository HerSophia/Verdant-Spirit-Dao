# 模块设计文档：“天时” - 动态天气与节气模块 (v2.1 - 基于响应式架构)

本文档旨在为“天时”模块设计详细、可靠的技术实现方案，并使其与项目 v2.1 的完全响应式架构保持一致。

## 1. 核心目标

将游戏中现有的、简单的天气状态，升级为一个包含季节、节气、常规天气、极端天气和特殊天象，并能对叙事和玩法产生实际影响的动态环境系统。

## 2. 设计哲学 (v2.1)

*   **状态驱动 (State-Driven)**: 模块的核心逻辑内聚在独立的 `weatherStore` 中。天气的变化是响应上游 `timeStore` 状态（游戏天数、时辰）变化的结果，实现了清晰的单向数据流。
*   **单一事实来源 (Single Source of Truth)**: 所有与天气相关的权威状态 (`世界.天气`) 都由 `worldStore` 统一维护。`weatherStore` 作为一个无状态的门面，仅负责派生状态和处理业务逻辑计算。
*   **解耦与内聚**: 天气演变的计算逻辑完全内聚在 `weatherStore` 内部。它通过向 `reactiveMessageBus` 派发内部事件来请求状态变更，由 `storeOrchestrator` 和 `worldStore` 完成最终的状态更新，实现了高度解耦。
*   **叙事与玩法结合**: 天气和节气的变化不仅是背景板，更要成为催生新玩法、新叙事和新传闻的源头。

## 3. 技术实现 (v2.1)

### 3.1. 状态扩展与演变逻辑

**数据结构扩展 (`weatherStore.ts` & `types.ts`)**:
*   `世界.天气` 变量是一个结构化的对象，其结构由Zod在 `weatherStore.ts` 中定义 (`WeatherSchema`)：
    ```typescript
    const WeatherSchema = z.object({
      当前天气: z.string(),
      天气描述: z.string(),
      季节: z.string(),
      节气: z.string(),
      特殊天象: z.string().optional().nullable(),
      效果: z.array(z.string()),
      天气影响: z.array(WeatherInfluenceSchema).optional().nullable(),
    }).passthrough();
    ```
*   `天气影响` 是一个数组，用于存储来自外部系统（主要是LLM）的主动影响。每个影响都是一个对象，例如：
    `{ "类型": "祈雨", "来源": "事件:春日祭典", "强度": 0.8, "剩余时长": 12 }` (时长单位：时辰)

**演变逻辑 (`weatherStore.ts` 中的 `updateWeatherOnTimeChange` 函数)**:
*   **触发器**: `weatherStore` `watch` 监听 `timeStore.day` 的变化。当游戏天数推进时，`updateWeatherOnTimeChange` 函数被调用。
*   **天气变化算法**:
    1.  `updateWeatherOnTimeChange` 函数负责完成所有天气计算（包括季节、节气、概率修正、随机选择等）。
    2.  计算出最终的 `newWeatherState` 对象后，它**不直接修改任何状态**。
    3.  而是通过 `emit('weatherCalculated', { newState: newWeatherState })` 将结果发布到内部事件总线。
*   **状态更新**: `storeOrchestrator` 监听到 `weatherCalculated` 事件，并调用 `worldStore.updateWorldState('天气', ...)` 来原子化地更新 `世界.天气` 变量并触发持久化。

### 3.2. LLM 集成

LLM 是驱动天气变化的重要外部因素。它通过生成特定事件来影响天气系统的概率模型或直接设置特殊天象。

*   **`施加天气影响` 事件**:
    *   **用途**: 用于在一段时间内，通过修正概率来**影响**而非**决定**天气。例如，角色施法“祈雨”会增加下雨的概率，但不保证一定会下雨。
    *   **`type`**: `"施加天气影响"`
    *   **`payload`**: 包含 `影响类型`, `强度`, `持续时间`, `来源`, `描述` (可选) 字段的对象。
    *   **支持的 `影响类型`**: `祈雨`, `干旱`, `强风`, `灵气浓郁`, `引发风暴`, `引发暴雪`, `引发冰雹`。

*   **`设置特殊天象` 事件**:
    *   **用途**: 用于在特定条件下（如夜间）直接**设置**一个特殊天象，覆盖正常的天气效果。
    *   **`type`**: `"设置特殊天象"`
    *   **`payload`**: 包含 `天象类型`, `来源`, `描述` (可选) 字段的对象。
    *   **支持的 `天象类型`**: `血月`。
*   **事件处理**: 所有天气相关的LLM事件，都由 `worldStore` 在其 `_dangerouslyProcessEvents` 方法中统一处理。`worldStore` 会调用 `weatherStore` 暴露的内部辅助函数 (`_handleWeatherEvent`) 来执行具体的计算逻辑，但状态修改和持久化的权力始终保留在 `worldStore` 中。

## 4. 天气与天象详解

| 天气/天象 | 类型 | 效果 | 触发方式 |
| :--- | :--- | :--- | :--- |
| **常规天气** | | | |
| 晴朗 | 常规 | 心情愉悦 | 自然发生 |
| 微雨 | 常规 | 植物生长加速 | 自然发生, `祈雨`影响 |
| 多云 | 常规 | 无 | 自然发生 |
| 烈日 | 常规 | 体力消耗加快, 易中暑 | 自然发生 (夏季) |
| 雷阵雨 | 常规 | 雷系功法修炼加成, 危险 | 自然发生 (夏季), `祈雨`影响 |
| 闷热 | 常规 | 体力恢复减慢 | 自然发生 (夏季) |
| 秋高气爽 | 常规 | 采集收获增加 | 自然发生 (秋季) |
| 阴天 | 常规 | 无 | 自然发生 |
| 小雨 | 常规 | 无 | 自然发生, `祈雨`影响 |
| 小雪 | 常规 | 寒冷 | 自然发生 (冬季) |
| 阴冷 | 常规 | 寒冷, 体力消耗加快 | 自然发生 (冬季) |
| 晴暖 | 常规 | 无 | 自然发生 (冬季) |
| 大风 | 常规 | 行动不便, 部分植物可能受损 | `强风`影响 |
| **特殊天气** | | | |
| 灵气雨 | 特殊 | 灵气充裕, 所有植物生长加速, 修炼速度提升 | `灵气浓郁`影响 |
| **极端天气** | | | |
| 冰雹 | 极端 | 危险, 建筑可能受损, 植物严重受损 | 自然发生 (夏/秋季, 小概率), `引发冰雹`影响 |
| 风暴 | 极端 | 极度危险, 无法外出, 建筑可能受损 | `引发风暴`影响 |
| 暴雪 | 极端 | 极度危险, 无法外出, 建筑可能受损, 极度寒冷 | `引发暴雪`影响 (仅冬季) |
| **特殊天象** | | | |
| 血月 | 天象 | (由具体模块定义, 如妖兽攻击性增强) | `设置特殊天象`指令 (仅夜间) |

## 5. 对其他模块的影响（玩法与叙事联动）

其他模块可以通过监听 `worldStore` 的状态，来实现丰富的联动效果：

*   **种植/图鉴模块 (`pokedexStore`)**: 可以 `watch` `worldStore.weather` 的 `季节` 和 `节气` 字段。
    *   某些灵植只在特定季节或节气才能生长或收获。
    *   某些灵兽只在特定天气（如“雷雨天”）或天象（如“血月”）下才会出现。
*   **“山野传闻”模块 (`rumorStore`)**: 可以 `watch` `worldStore.weather`。
    *   可以生成与季节和天气相关的传闻，例如“今年的冬天好像特别冷，怕不是有什么预兆。”
*   **“奇遇”模块 (`adventureStore`)**: 可以 `watch` `worldStore.weather.特殊天象`。
    *   “血月”这样的特殊天象，是触发某些史诗级奇遇的绝佳时机。
*   **NPC模块 (`npcStore`)**: 可以 `watch` `worldStore.weather.当前天气`。
    *   NPC的日程可以受天气影响，例如“雨天，老张头就不会去河边钓鱼，而会待在酒馆里。”
*   **修炼/战斗模块 (`cultivationStore`)**: 可以 `watch` `worldStore.weather`。
    *   玩家在“雷雨天”修炼雷系功法可能会有加成或危险。
    *   在“血月”期间，妖兽的攻击性可能会增强。
