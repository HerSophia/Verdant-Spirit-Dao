# 模块设计文档：“庇护所” - 动态基地建设与管理模块

本文档旨在为“庇护所”模块设计详细、可靠的技术实现方案，将其从一个简单的状态描述升级为一个动态、可互动、对游戏玩法和叙事产生深远影响的核心基地系统。

## 1. 核心目标与哲学

* **核心目标**: 将庇护所从一个静态的玩家属性，转变为一个可建造、可升级、可维护、可防御的动态实体。它将成为玩家在玄幻修仙世界中的“家”，提供资源产出、安全保障、修炼场所和社交中心。
* **设计哲学**:
  * **玩家投入与回报**: 玩家对庇护所的投入（时间、资源、精力）应能获得明确的回报（更强的防御、更高的产出、更好的修炼环境）。
  * **环境互动**: 庇护所应能与游戏世界中的天气、事件、NPC等进行互动，而非孤立存在。
  * **叙事驱动与系统支撑**: 庇护所的重大变化（如升级、遭受攻击）应由LLM在叙事中驱动，但其内部状态和效果必须由系统精确计算和维护。
  * **模块化与可扩展**: 庇护所的各个子系统（如防御、生产、舒适度）应设计为可独立扩展的模块。

## 2. 设计原则

* **即插即用**: 模块的核心逻辑应监听现有事件（如 `timeChanged`），在不侵入核心逻辑的情况下，为庇护所赋予更丰富的动态变化。
* **数据驱动**: 所有的庇护所效果（如资源产出、防御强度）都应由其他模块监听“庇护所”模块派发的事件来驱动，而不是在本模块内硬编码。
* **叙事与玩法结合**: 庇护所的变化不仅是背景板，更要成为催生新玩法、新叙事和新传闻的源头。
* **状态原子性**: 庇护所的每个组件（如围墙、农田）都应有其独立的状态，支持精确的增量更新。

## 3. 技术方案构思

### 3.1. 状态扩展与演变逻辑

**数据结构扩展**:
我们需要扩展现有的 `世界.庇护所` 变量，从一个简单的结构，升级为一个包含多个子系统的结构化对象。

```json
"庇护所": {
  "名称": "望海崖居",
  "规模": "石木混合结构", // 庇护所的整体规模，影响解锁的功能上限
  "状态": "稳固", // 整体状态，如“稳固”、“受损”、“废弃”
  "舒适度": "良好", // 影响玩家心情、修炼效率等
  "防御力": "坚固", // 影响抵御外部攻击的能力
  "功能": [ // 整体功能列表，由子系统提供
    "🔨 简易工作台",
    "🔥 石砌壁炉",
    "🛏️ 干草床铺"
  ],
  "组件": { // 庇护所的各个可升级/建造的组件
    "围墙": {
      "规模": "一般",
      "材料": "木材",
      "耐久度": "完好无损",
      "防御加成": "微弱"
    },
    "屋顶": {
      "规模": "潦草",
      "材料": "茅草",
      "耐久度": "完好无损",
      "防雨加成": "轻微"
    },
    "农田": {
      "id": "farm_001",
      "规模": "未开垦",
      "状态": "未建造", // 或 "空闲", "种植中"
      "作物": null, // 当前种植的作物ID
      "产出效率": "普通" // 影响作物生长速度和产量
    },
    "药园": {
      "id": "herb_001",
      "规模": "未开垦",
      "状态": "未建造",
      "药材": null,
      "产出效率": "普通"
    },
    "防御阵法": {
      "规模": "未布置",
      "状态": "未激活", // 或 "激活中", "破损"
      "灵力消耗": "无",
      "防御加成": "无"
    }
  },
  "事件日志": [ // 记录庇护所发生的重大事件，如攻击、修复
    { "天数": 10, "类型": "攻击", "摘要": "遭受妖兽小股袭击，围墙轻微受损" },
    { "天数": 15, "类型": "升级", "摘要": "围墙升级至2级" }
  ]
}
```

* `舒适度` 和 `防御力` 是综合属性，由各个 `组件` 的状态计算得出。
* `功能` 列表由已建造和升级的 `组件` 动态生成。
* `组件` 内部可以有自己的 `规模`、`材料`、`耐久度` 等属性。

**演变逻辑**:

* **触发器**: 模块的核心逻辑由 `timeChanged` 事件驱动，理想情况下每个“时辰”触发一次。
* **耐久度衰减**: 庇护所的各个组件（如围墙、屋顶）的 `耐久度` 会随时间（或特定天气、事件）缓慢衰减。
* **环境影响**:
  * `weatherChanged` 事件会影响庇护所组件的 `耐久度` 衰减速度（例如，暴雨会加速屋顶耐久度下降）。
  * `celestialEventStarted` 事件可能触发特殊事件，如妖兽潮，直接影响庇护所的 `防御力` 和 `耐久度`。
* **LLM的角色转变**: LLM不再直接“升级”庇护所，而是通过游戏内事件（如玩家完成了某个建造任务、触发了某个奇遇）向系统**施加一个“庇护所影响”**或触发建造/升级事件。
    > LLM输出示例: `{"事件": "庇护所建造", "payload": { "组件": "农田", "规模": "初阶", "描述": "你开辟了一片肥沃的农田。" }}`
    > `shelterHandler` 接收到这个指令后，会更新 `世界.庇护所.组件.农田` 的状态。

### 3.2. 响应式状态联动 (v2.0)

根据最新的响应式架构，模块的核心逻辑已迁移至独立的 `shelterStore`。

*   **核心职责**: `worldStore` 负责维护庇护所的权威状态 (`世界.庇护所`)。`shelterStore` 则作为一个无状态的**门面 (Facade)**，负责处理复杂的业务逻辑计算，并为UI层提供派生状态。
*   **联动方式**: 其他模块（如 `itemStore`、`questStore`）通过监听 `worldStore` 中庇护所相关的状态来响应变化。

### 3.3. 对其他模块的影响（玩法与叙事联动）

其他模块可以通过监听 `worldStore.shelter` 的状态变化，来实现丰富的联动效果：

*   **物品系统 (`itemStore`)**:
    *   庇护所的资源产出逻辑，应计算出结果后，生成一个标准的 `物品变化` 事件并推送到 `eventLogStore`。`worldStore` 将统一处理此事件，从而确保所有物品变更都可追溯。
    *   庇护所建造/升级时，`worldStore` 在处理相应事件时，会调用 `itemStore` 的 `removeItem` action 来消耗材料。
*   **“天时”模块 (`weatherStore`)**:
    *   `shelterStore` 自身会监听 `timeStore` 的变化，并从 `weatherStore` 读取当前天气状态，来计算天气对庇护所组件的耐久度衰减。
    *   季节变化（来自 `weatherStore`）会影响农田/药园的产出效率。
*   **“奇遇”模块 (`adventureStore`)**:
    *   `adventureStore` 可以监听 `worldStore.shelter` 的防御力 getter。当防御力低于某个阈值时，可能会提高特定危险奇遇的发生概率。
*   **“山野传闻”模块 (`rumorStore`)**:
    *   `rumorStore` 可以监听 `worldStore.shelter` 的事件日志。当有新的“被攻击”日志出现时，可以生成相关的传闻。
*   **NPC模块 (`npcStore`)**:
    *   `npcStore` 可以监听 `worldStore.shelter` 的舒适度 getter，以决定 NPC 是否来访。
*   **任务系统 (`questStore`)**:
    *   `questStore` 可以监听 `worldStore.shelter` 中组件的状态。当某个组件的耐久度变为“毁坏”时，可以自动触发一个修复任务。
*   **修炼模块 (`cultivationStore`)**:
    *   `cultivationStore` 可以监听 `worldStore.shelter` 的舒适度或特殊功能（如聚灵阵）的状态，为玩家的修炼效率提供加成。

* **“天时”模块 (`MODULE_DESIGN_WEATHER.md`)**:
  * `weatherChanged` 事件会影响庇护所组件的耐久度衰减。
  * `seasonChanged` 事件会影响农田/药园的产出效率。
* **“奇遇”模块 (`MODULE_DESIGN_ADVENTURE.md`)**:
  * `celestialEventStarted` 事件可能触发妖兽潮，导致 `shelterAttacked` 事件。
  * 庇护所的防御力可以影响奇遇中玩家遭遇危险的概率。
* **“山野传闻”模块 (`MODULE_DESIGN_RUMOR.md`)**:
  * 可以生成与庇护所相关的传闻，例如“听说望海崖居最近遭受了妖兽袭击，损失惨重。”
* **NPC模块**:
  * NPC可以根据庇护所的 `舒适度` 或 `防御力` 决定是否访问庇护所，或提供相关任务。
* **任务系统**:
  * 庇护所的建造、升级、修复可以作为任务目标。
  * 防御庇护所可以触发防御任务。
* **修炼模块**:
  * 庇护所的 `舒适度` 或特殊功能（如聚灵阵）可以影响玩家的修炼效率。

## 4. 详细技术实现

### 4.1. 数据结构定义

#### 4.1.1. 核心状态 (`VARIABLES_SPEC.md`)

游戏的核心状态变量 `世界.庇护所` 将被扩展为以下结构：

```json
"庇护所": {
  "名称": "望海崖居",
  "规模": "石木混合结构", // 庇护所的整体规模，影响解锁的功能上限
  "状态": "稳固", // 整体状态，如“稳固”、“受损”、“废弃”
  "舒适度": "良好", // 影响玩家心情、修炼效率等
  "防御力": "坚固", // 影响抵御外部攻击的能力
  "功能": [ // 整体功能列表，由子系统提供
    "🔨 简易工作台",
    "🔥 石砌壁炉",
    "🛏️ 干草床铺"
  ],
  "组件": { // 庇护所的各个可升级/建造的组件
    "围墙": {
      "规模": "潦草",
      "材料": "木材",
      "耐久度": "完好无损",
      "防御加成": "微弱"
    },
    "屋顶": {
      "规模": "潦草",
      "材料": "茅草",
      "耐久度": "完好无损",
      "防雨加成": "轻微"
    },
    "农田": {
      "id": "farm_001",
      "规模": "未开垦",
      "状态": "未建造", // 或 "空闲", "种植中"
      "作物": null, // 当前种植的作物ID
      "产出效率": "普通" // 影响作物生长速度和产量
    },
    "药园": {
      "id": "herb_001",
      "规模": "未开垦",
      "状态": "未建造",
      "药材": null,
      "产出效率": "普通"
    },
    "防御阵法": {
      "规模": "未布置",
      "状态": "未激活", // 或 "激活中", "破损"
      "灵力消耗": "无",
      "防御加成": "无"
    }
  },
  "事件日志": [ // 记录庇护所发生的重大事件，如攻击、修复
    { "天数": 10, "类型": "攻击", "摘要": "遭受妖兽小股袭击，围墙轻微受损" },
    { "天数": 15, "类型": "升级", "摘要": "围墙升级至2级" }
  ]
}
```

#### 4.1.2. 模块内部数据 (`data/shelter-data.ts` - 新增)

为了定义庇护所组件的升级路径、所需材料和效果，我们需要一个静态数据源。这里建议统一使用数值系统，并建立数值到描述性文字的映射关系。

```typescript
// 位于 data/shelter-data.ts

// 数值到描述性文字的映射配置
export const SHELTER_DESCRIPTIVE_MAPPING = {
  defense: {
    0: "无",
    10: "微弱",
    20: "显著", 
    30: "强大",
    50: "坚不可摧"
  },
  efficiency: {
    0: "无",
    0.1: "轻微",
    0.3: "中等",
    0.5: "高效",
    1.0: "极效"
  },
  durability: {
    0: "毁坏",
    30: "严重受损",
    60: "轻微受损",
    80: "基本完好",
    100: "完好无损"
  }
};

export const SHELTER_COMPONENTS_DATA = {
  "围墙": {
    "baseDefense": 10,
    "upgrades": {
      "1": { "materials": [{ "name": "潮汐木芯", "quantity": 10 }], "defenseBonus": 10, "description": "木制围墙，提供基础防御。" },
      "2": { "materials": [{ "name": "石块", "quantity": 20 }], "defenseBonus": 20, "description": "石制围墙，防御力更强。" }
    }
  },
  "农田": {
    "baseEfficiency": 1.0,
    "upgrades": {
      "0": { "materials": [], "description": "未建造" },
      "1": { "materials": [{ "name": "泥土", "quantity": 5 }], "efficiencyBonus": 0.1, "description": "开辟一片小农田。" }
    },
    "production": {
      "type": "continuous",
      "resource": "谷物",
      "baseRate": 1
    }
  },
  "水渠": {
    "baseEfficiency": 1.0,
    "upgrades": {
      "0": { "materials": [], "description": "未建造" },
      "1": { "materials": [{ "name": "石块", "quantity": 10 }], "efficiencyBonus": 0.2, "description": "挖掘一条简单的水渠，引导水源。" }
    },
    "production": {
      "type": "continuous",
      "resource": "净水",
      "baseRate": 2
    }
  },
  "池塘": {
    "baseEfficiency": 1.0,
    "upgrades": {
      "0": { "materials": [], "description": "未建造" },
      "1": { "materials": [{ "name": "泥土", "quantity": 10 }, { "name": "石块", "quantity": 5 }], "efficiencyBonus": 0.1, "description": "挖掘一个小型池塘，养殖鱼类。" }
    },
    "production": {
      "type": "continuous",
      "resource": "鲜鱼",
      "baseRate": 0.5
    }
  }
};

// 状态转换规则定义
export const SHELTER_STATUS_RULES = {
  // 整体状态转换
  overallStatus: {
    "稳固": { minDefense: 30, minComfort: 70 },
    "受损": { minDefense: 10, maxDefense: 29, minComfort: 30 },
    "废弃": { maxDefense: 9, maxComfort: 29 }
  },
  // 组件状态转换
  componentStatus: {
    "完好无损": { minDurability: 80 },
    "轻微受损": { minDurability: 60, maxDurability: 79 },
    "严重受损": { minDurability: 30, maxDurability: 59 },
    "毁坏": { maxDurability: 29 }
  }
};
```

### 4.2. 核心逻辑实现 (`stores/systems/shelterStore.ts`)

庇护所的核心逻辑由 `worldStore` 和 `shelterStore` 协同完成。

*   **时间驱动逻辑 (`updateShelterOnTimeChange` - 待重构)**:
    *   **监听器**: `shelterStore` 监听 `timeStore` 的 `day` 变化。
    *   **核心算法 (重构方向)**:
        1.  **计算变化**: `shelterStore` 中的函数负责计算因时间流逝和天气影响导致的**耐久度衰减**和**资源产出**。
        2.  **派发事件**: 计算完成后，该函数不直接修改状态，而是：
            *   通过 `reactiveMessageBus` 发出一个内部事件（如 `shelterDecayCalculated`），载荷为各组件的耐久度变化量。`worldStore` 将监听此事件并应用状态变更。
            *   生成一个或多个 `物品变化` 事件，并通过 `eventLogStore.addEvents` 推送，以处理资源产出。

*   **LLM事件驱动逻辑**:
    *   **处理器**: 对庇护所状态的所有修改，都由 `worldStore` 在其 `_dangerouslyProcessEvents` 方法中统一处理。
    *   **逻辑委托**: `worldStore` 会调用 `shelterStore` 暴露的内部辅助函数（如 `_handleShelterEvent`）来执行具体的事件计算逻辑，但最终的状态修改权和持久化权始终保留在 `worldStore` 中。

### 4.3. LLM指令格式 (`PROMPTS_SPEC.md`)
>>>>>>>
>>>>>>> Stashed changes

为了让LLM能够驱动庇护所的变化，我们需要在 `PROMPTS_SPEC.md` 中定义新的指令格式：

* **目的**: 建造/升级庇护所组件。
* **JSON结构**:

    ```json
    {
      "指令": "庇护所建造", // 或 "庇护所升级", "庇护所修复", "庇护所受损", "庇护所攻击"
      "组件ID": "围墙", // 或 "农田", "屋顶" 等
      "等级": "中阶", // 目标等级，仅适用于建造/升级
      "数量": "少量", // 修复或受损的数量/强度
      "描述": "你耗费心力，将庇护所的围墙升级到了石制结构。" // 给玩家的反馈
    }
    ```

* **处理逻辑**: `shelterHandler` 将负责监听并解析这种结构的指令，并将其转换为对 `世界.庇护所` 变量的更新。

### 4.4. LLM 集成方案

* **Prompt 增强 (prompts-data.ts)**:
  * 在玩家进行建造、升级、防御等行为时，LLM需要根据当前庇护所的状态、玩家的物品、世界事件等，生成相应的叙事和事件。
  * 例如，当玩家拥有足够材料并选择升级围墙时，LLM会生成 `庇护所升级` 事件。
  * 当庇护所遭受攻击时，LLM会生成 `庇护所攻击` 事件。

## 5. 用户体验优化设计

### 5.1. 可视化反馈系统

* **状态指示器**: 为每个组件添加颜色编码的状态指示（绿色=完好，黄色=轻微受损，红色=严重受损，灰色=毁坏）
* **进度条显示**: 在UI中显示耐久度进度条，直观展示组件状态
* **建造动画效果**: 建造和升级时添加简单的动画效果，增强反馈感
* **环境互动提示**: 当天气变化影响庇护所时，显示明显的视觉提示

### 5.2. 建造进度系统

* **分阶段建造**: 将大型组件的建造分为多个阶段，每个阶段都有明确的进度显示
  * **LLM驱动决策**: 建造进度和资源消耗主要由LLM决定，通过派发事件来推进建造
  * **系统状态维护**: 系统负责接收LLM事件并更新组件状态，确保数据一致性
  * **事件示例**: `{"事件": "庇护所建造进度", "payload": {"组件": "围墙", "阶段": 2, "消耗资源": [{"name": "木材", "quantity": 5}], "描述": "你耗费木材完成了围墙的基础结构"}}`
* **里程碑奖励**: 在完成重要建造里程碑时给予玩家奖励和成就感
* **建造队列**: 支持玩家规划多个建造任务，显示预计完成时间

### 5.3. 信息展示优化

* **悬浮提示**: 鼠标悬停时显示组件的详细信息和当前状态
* **统计面板**: 提供庇护所整体统计信息（总防御力、舒适度、资源产出等）
* **历史记录**: 可视化展示事件日志中的重要事件时间线
* **比较视图**: 显示升级前后的属性对比，帮助玩家做出建造决策

### 5.4. 交互设计

* **一键修复**: 提供快速修复所有受损组件的功能
* **智能推荐**: 根据当前资源和需求，推荐最优的建造/升级顺序
* **快捷操作**: 为常用操作设置快捷键，提升操作效率
* **移动端适配**: 确保UI在移动设备上也有良好的操作体验

## 6. 实施步骤

1. **创建本文档**: 在 `docs/` 目录下创建 `MODULE_DESIGN_SHELTER.md`。
2. **更新 `VARIABLES_SPEC.md`**: 按照 `4.1.1` 的定义，修改 `世界.庇护所` 的结构。
3. **创建 `data/shelter-data.ts`**: 创建新文件，并按照 `4.1.2` 的格式定义庇护所组件的升级数据。
4. **创建/重构 `core/events/shelterHandler.ts`**:
    * 创建新文件或重构现有 `shelterUpgradeHandler.ts`。
    * 实现 `shelterHandler` 函数，包含 `4.2` 中描述的核心算法。
    * 从 `data/shelter-data.ts` 导入组件数据。
5. **注册处理器**:
    * 在 `shelterHandler.ts` 中，导出一个新的初始化函数 `initializeShelterListener`，内部使用 `messageBus` 监听 `timeChanged` 事件。

        ```typescript
        // shelterHandler.ts
        export function initializeShelterListener() {
          messageBus.on('timeChanged', (payload) => {
            const hoursPassed = (payload.toDay - payload.fromDay) * 12;
            if (hoursPassed > 0) {
              shelterHandler.handleTimeChange(hoursPassed);
            }
          });
        }
        ```

    * 在 `index.ts` 中，导入并调用 `initializeShelterListener()` 来激活监听器。
    * 在 `index.ts` 中，照常注册LLM事件处理器：`eventManager.register('庇护所建造', shelterHandler)`, `eventManager.register('庇护所升级', shelterHandler)` 等。
6. **更新 `EVENT_MANAGER_SPEC.md`**: 在文档中正式添加 `4.3.1` 中定义的所有新事件，供其他模块开发者参考。
7. **更新 `prompts-data.ts`**: 定义 `4.3.2` 中描述的LLM指令格式，引导LLM生成庇护所相关事件。
8. **更新 `core/systems.ts`**:
    * 修改 `renderShelterData` 函数（或创建新的 `renderShelterSystem`），实现第5章描述的用户体验优化功能
    * 添加状态指示器、进度条、建造动画等视觉反馈
    * 实现信息展示优化和交互设计改进
9. **扩展其他模块**:
    * **物品Store**: 创建 `stores/itemStore.ts`，负责管理玩家的背包。它将监听 `shelterResourceProduced` 事件，自动将产出的资源添加到背包中。
    * **任务系统**: 增加庇护所相关的任务目标，并与建造进度系统集成。
    * **天气模块**: 监听 `shelterDamaged` 事件，根据天气影响庇护所耐久度，并提供环境互动提示。
10. **用户体验测试**:
    * 进行可用性测试，确保UI直观易用
    * 收集玩家反馈，持续优化用户体验
    * 确保移动端和桌面端都有良好的操作体验

## 7. 总结

本模块设计文档详细规划了"庇护所"系统的技术实现方案，将庇护所从一个简单的状态描述升级为动态、可互动、对游戏玩法和叙事产生深远影响的核心基地系统。

### 核心特色

* **LLM驱动建造**: 建造进度和资源消耗由LLM主导决策，通过事件驱动推进
* **系统状态维护**: 系统负责可靠的状态更新和数据一致性保证
* **数值描述映射**: 建立数值系统与描述性文字的映射关系，兼顾技术精确性和叙事沉浸感
* **模块化设计**: 各个子系统可独立扩展，支持丰富的玩法联动

### 技术优势

* **即插即用**: 监听现有事件，不侵入核心逻辑
* **数据驱动**: 效果由其他模块监听事件来驱动，而非硬编码
* **性能优化**: 对频繁事件进行节流处理，确保系统效率
* **可扩展性**: 支持未来添加新的组件类型和功能

### 用户体验

* **可视化反馈**: 状态指示器、进度条、建造动画等增强玩家沉浸感
* **智能交互**: 一键修复、智能推荐、快捷操作等提升操作效率
* **多端适配**: 确保移动端和桌面端都有良好的操作体验

该设计方案实现了叙事驱动与系统支撑的完美结合，为玩家提供了丰富、沉浸的基地建设与管理体验。

## 8. 未来展望与 TODO (LLM 驱动细节)

在系统规则的基础上，我们可以引入 LLM 来为庇护所的管理和发展注入更多活力、随机性和叙事深度。以下是各阶段任务中可以由 LLM 驱动的方面：

### 阶段一：核心玩法闭环

* **[ ] 实现修复/升级功能 (LLM 叙事增强)**
  * **系统**: `worldStore` 和 `itemStore` 负责处理修复/升级的**硬性规则**（材料是否足够，能否升级）。
  * **✨ LLM 驱动**: 当玩家点击“修复”或“升级”时，系统可以向 LLM 发送一个包含上下文的 prompt（如“玩家试图用[材料]修复[组件]，但他缺少[缺失的材料]”）。
  * **LLM 随机化**:
    * **成功**: LLM 可以生成生动的成功描述（“你熟练地将灵木嵌入墙体，裂缝随着灵光闪动而愈合了。”）。
    * **失败 (材料不足)**: LLM 可以叙述失败的原因，并可能触发一个**小型动态任务**（“你发现还缺少关键的‘百年铁木心’。或许山那边的黑市商人‘李鬼’会有门路？”）。
    * **意外事件**: LLM 可以在建造/修复过程中引入小波折（“正当你施工时，一只调皮的灵猴偷走了你的工具！”），生成一个临时的负面状态或一个小型寻回任务。

### 阶段二：深化系统联动

* **[ ] 与任务系统联动 (LLM 生成动态任务)**
  * **系统**: `questStore` 监听到组件“毁坏”状态，这是任务生成的**触发器**。
  * **✨ LLM 驱动**: `questStore` 不是生成一个模板化的“请修复XX”任务，而是向 LLM 请求生成一个与当前游戏上下文相关的任务。
  * **LLM 随机化**:
    * **任务内容**: LLM 可以根据毁坏原因（天气、战斗）生成不同的任务。“你的农田在上次的酸雨中被腐蚀了，需要寻找‘青灵草’的汁液来中和土壤。” vs “围墙被妖兽撞出了一个大洞，你需要一些‘巨岩蜥的硬皮’来修补它。”
    * **任务NPC**: LLM 可以动态地将任务与一个当前场景的 NPC 关联起来。

* **[ ] 细化环境影响 (LLM 解释和触发特殊事件)**
  * **系统**: `worldStore` 根据季节和天气应用**基础修正系数**。
  * **✨ LLM 驱动**: 当季节变换或发生特殊天气时，系统可以请求 LLM 生成一段叙事，并可能附带一个一次性的庇护所事件。
  * **LLM 随机化**:
    * **季节事件**: “凛冬已至，寒潮比往年更加猛烈。你发现庇护所的木柴储备消耗得特别快，甚至一些食物也因为保存不当而冻坏了。” (触发一次性的物品损耗事件)
    * **天气事件**: “一场罕见的雷暴过后，你发现后山的灵脉似乎被引动了。你的聚灵阵（如果已建造）在接下来的一天里效率大增。” (触发一个临时的正面 buff)

### 阶段三：丰富叙事与后期内容

* **[ ] 庇护所事件日志与传闻系统 (LLM 生成传闻)**
  * **系统**: `worldStore` 记录结构化的事件日志（“{day: 10, type: 'attack', result: 'minor_damage'}”）。
  * **✨ LLM 驱动**: `rumorStore` 将这条结构化日志作为上下文，请求 LLM 将其“翻译”成一条生动的世界传闻。
  * **LLM 随机化**:
    * **传闻内容**: “听说了吗？望海崖居的那个修士前两天被妖兽围攻了，好像挺狼狈的。” vs “望海崖居真是固若金汤！听说一群妖兽去闹事，结果连根毛都没伤到！”
    * **传播者**: LLM 可以决定这条传闻是从哪个 NPC 的口中说出来的。

* **[ ] 人员管理系统 (LLM 驱动 NPC 互动)**
  * **系统**: 玩家指派 NPC 工作，系统根据规则计算效率加成。
  * **✨ LLM 驱动**: 在指派或工作的过程中，可以触发由 LLM 生成的特殊互动或事件。
  * **LLM 随机化**:
    * **NPC 的反馈**: 指派 NPC 去农田工作时，如果该 NPC 对种植有心得，LLM 可以生成一段他/她分享种植技巧的对话，甚至可能解锁一个隐藏的作物特性。
    * **工作中的事件**: “张三在池塘工作时，意外发现了一尾罕见的‘金鳞锦鲤’，似乎能给庇护所带来好运。” (触发一个临时的幸运 buff 或获得一件特殊物品)。
