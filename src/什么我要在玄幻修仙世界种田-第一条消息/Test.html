<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apex模型能力测试 - 互动小说开篇 (Test)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap');

    body {
      font-family: 'Inter', 'Noto Serif SC', serif;
      background-color: #111827;
      /* 深灰蓝背景 */
      color: #E5E7EB;
      /* 浅灰色文字 */
    }

    .prose-custom h1,
    .prose-custom h2,
    .prose-custom h3 {
      font-family: 'Noto Serif SC', serif;
      color: #F9FAFB;
      /* 白色标题 */
      border-left: 4px solid #3B82F6;
      /* 蓝色左边框 */
      padding-left: 1rem;
    }

    .card {
      background-color: rgba(30, 41, 59, 0.5);
      /* 半透明深蓝灰色背景 */
      backdrop-filter: blur(10px);
      border: 1px solid rgba(55, 65, 81, 0.5);
      transition: all 0.3s ease-in-out;
    }

    .card:hover {
      border-color: #3B82F6;
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.1), 0 4px 6px -2px rgba(59, 130, 246, 0.05);
    }

    .tag {
      background-color: #374151;
      /* 深灰色标签 */
      color: #D1D5DB;
      /* 灰色文字 */
    }

    .world-bg {
      background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=2071&auto=format&fit=crop');
      background-size: cover;
      background-position: center;
      position: relative;
    }

    .world-bg::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to top, #111827, rgba(17, 24, 39, 0.7));
    }

    .char-bg {
      background-image: url('https://images.unsplash.com/photo-1544716278-e513176f20b5?q=80&w=1974&auto=format&fit=crop');
      background-size: cover;
      background-position: center;
      position: relative;
    }

    .char-bg::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to top, #111827, rgba(17, 24, 39, 0.7));
    }

    .tab-button {
      transition: all 0.3s ease;
    }

    .tab-button.active {
      background-color: #3B82F6;
      color: #F9FAFB;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .prose-custom h1,
      .prose-custom h2,
      .prose-custom h3 {
        padding-left: 0.75rem;
        border-left-width: 3px;
      }

      .card {
        padding: 1rem;
      }
    }

    @media (max-width: 640px) {
      .tab-button {
        padding: 0.5rem 0.25rem;
        font-size: 0.8rem;
      }

      .tab-button .fas {
        margin-right: 0.25rem;
      }
    }

    /* Collapsible sections */
    .collapsible-section summary {
      position: relative;
      padding-right: 2rem; /* Space for the icon */
    }

    .collapsible-section summary::after {
      content: '\f078'; /* Font Awesome chevron-down */
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%) rotate(0deg);
      transition: transform 0.3s ease;
    }

    .collapsible-section[open] > summary::after {
      transform: translateY(-50%) rotate(180deg);
    }

    /* On mobile, collapse sections by default */
    @media (max-width: 768px) {
      .collapsible-section {
        border-bottom: 1px solid rgba(55, 65, 81, 0.5);
        padding-bottom: 1rem;
        margin-bottom: 1rem;
      }
      .collapsible-section:not([open]) {
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
      }
      .collapsible-section[open] {
        padding-bottom: 1.5rem;
      }
      .collapsible-section:last-of-type {
        border-bottom: none;
      }
      .collapsible-section > summary {
        margin-bottom: 0;
      }
      .collapsible-section:not([open]) > *:not(summary) {
          display: none;
      }
    }

    /* Custom Scrollbar */
    #inventory-items-container::-webkit-scrollbar,
    #bag-items-container::-webkit-scrollbar {
      width: 8px;
    }

    #inventory-items-container::-webkit-scrollbar-track,
    #bag-items-container::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 10px;
    }

    #inventory-items-container::-webkit-scrollbar-thumb,
    #bag-items-container::-webkit-scrollbar-thumb {
      background-color: #3B82F6;
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: content-box;
    }

    #inventory-items-container::-webkit-scrollbar-thumb:hover,
    #bag-items-container::-webkit-scrollbar-thumb:hover {
      background-color: #2563EB;
    }
  </style>
</head>

<body class="antialiased">

  <div class="container mx-auto px-4 py-12 max-w-7xl">

    <!-- 标题区域 -->
    <header class="text-center mb-12 md:mb-16 prose-custom">
      <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold tracking-tight">什么？我要在玄幻修仙世界种田？</h1>
      <p class="mt-4 text-base md:text-lg text-gray-400">版本:
        v0.1</p>
      <p class="mt-4 text-xs md:text-sm text-gray-400">作者：goddess_boreas</p>
    </header>

    <!-- Tab 切换按钮 -->
    <div class="flex justify-center mb-8 space-x-2 md:space-x-4 bg-gray-800 rounded-lg p-2 max-w-md mx-auto">
      <button data-tab="worldview"
        class="tab-button flex-1 py-2 px-4 rounded-md text-sm md:text-base font-medium active"><i
          class="fas fa-globe-asia mr-2"></i>世界观速览</button>
      <button data-tab="character"
        class="tab-button flex-1 py-2 px-4 rounded-md text-sm md:text-base font-medium"><i
          class="fas fa-user-circle mr-2"></i>角色档案</button>
      <button data-tab="custom-start"
        class="tab-button flex-1 py-2 px-4 rounded-md text-sm md:text-base font-medium"><i
          class="fas fa-dice mr-2"></i>自定义开局</button>
    </div>

    <!-- Tab 内容区域 -->
    <main>
      <!-- 世界观内容 -->
      <div id="worldview" class="tab-content active">
        <div class="relative rounded-xl overflow-hidden p-6 sm:p-8 md:p-12 world-bg">
          <div class="relative z-10 prose-custom max-w-none">
            <h2 class="text-2xl sm:text-3xl font-bold">元初界</h2>
            <p class="text-gray-300">这是一个以“灵气”为万物本源与唯一修炼能量的玄幻修仙世界。大道至简，修行者专注于“道”与“法”的感悟，而非繁杂的等级突破。</p>

            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mt-8 md:mt-10">
              <!-- 境界设定 -->
              <div class="card rounded-lg p-6">
                <h3 class="font-bold text-xl mb-3 flex items-center"><i
                    class="fas fa-layer-group text-blue-400 mr-3"></i>核心境界</h3>
                <ul class="space-y-2 text-gray-400">
                  <li><span class="font-semibold text-gray-200">淬体境:</span> 凡躯打磨，仙凡之隔。</li>
                  <li><span class="font-semibold text-gray-200">炼气境:</span> 引气入体，初窥门径。</li>
                  <li><span class="font-semibold text-gray-200">筑基境:</span> 铸就道基，神识初醒。</li>
                  <li><span class="font-semibold text-gray-200">金丹境:</span> 丹成大道，御器飞行。</li>
                  <li><span class="font-semibold text-gray-200">元婴境:</span> 婴变不灭，瞬移千里。</li>
                  <li><span class="font-semibold text-gray-200">化神境:</span> 法则言随，神游太虚。</li>
                </ul>
              </div>
              <!-- 职业体系 -->
              <div class="card rounded-lg p-6">
                <h3 class="font-bold text-xl mb-3 flex items-center"><i
                    class="fas fa-briefcase text-green-400 mr-3"></i>多元职业</h3>
                <div class="space-y-3">
                  <div>
                    <h4 class="font-semibold text-gray-200">战斗类</h4>
                    <p class="text-gray-400 text-sm">剑修、法修、体修、魂修</p>
                  </div>
                  <div>
                    <h4 class="font-semibold text-gray-200">辅佐类</h4>
                    <p class="text-gray-400 text-sm">丹师、器师、阵师</p>
                  </div>
                  <div>
                    <h4 class="font-semibold text-gray-200">奇门类</h4>
                    <p class="text-gray-400 text-sm">符师、灵植师、御兽师</p>
                  </div>
                </div>
              </div>
              <!-- 开场舞台 -->
              <div class="card rounded-lg p-6 md:col-span-2 lg:col-span-1">
                <h3 class="font-bold text-xl mb-3 flex items-center"><i
                    class="fas fa-map-marked-alt text-purple-400 mr-3"></i>开场舞台：洄潮屿</h3>
                <p class="text-gray-400">位于无妄海东部，洋流交汇之地的隐秘洞天。表象平凡，内藏玄机。</p>
                <ul class="mt-3 space-y-2 text-gray-400">
                  <li><i class="fas fa-leaf text-green-500 mr-2"></i><b>息壤灵田:</b> 加速灵植生长，点化凡物。</li>
                  <li><i class="fas fa-water text-cyan-500 mr-2"></i><b>洋流宝库:</b> 海滩随机刷新资源与遗物。</li>
                  <li><i class="fas fa-skull-crossbones text-red-500 mr-2"></i><b>水下杀机:</b> 深海暗藏巨兽与上古遗迹。</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 角色档案内容 -->
      <div id="character" class="tab-content">
        <div class="relative rounded-xl overflow-hidden p-6 sm:p-8 md:p-12 char-bg">
          <div class="relative z-10 grid md:grid-cols-3 gap-6 md:gap-8">
            <!-- 角色基础信息 -->
            <div class="md:col-span-1 prose-custom">
              <h2 class="text-2xl sm:text-3xl font-bold">角色档案</h2>
              <h3 class="text-3xl sm:text-4xl font-serif mt-2" style="color: #60A5FA;">萧栖雪</h3>
              <p class="text-gray-300">"一位来自异世界的农业学者，在这片充满灵气的土地上，开始了她的种田修仙之旅。"</p>
              <div class="mt-6 space-y-4">
                <div><i class="fas fa-id-card fa-fw mr-3 text-gray-400"></i><span class="font-semibold">身份:</span> 散修 /
                  灵植师 (前世: 农业学生)</div>
                <div><i class="fas fa-map-pin fa-fw mr-3 text-gray-400"></i><span class="font-semibold">阵营:</span> 中立 /
                  秩序</div>
                <div><i class="fas fa-user-circle fa-fw mr-3 text-gray-400"></i><span class="font-semibold">性格:</span>
                  谨慎务实、聪慧坚韧、探索欲强</div>
              </div>
            </div>
            <!-- 核心设定与物品 -->
            <div class="md:col-span-2 space-y-6">
              <!-- 核心优势 -->
              <div class="card rounded-lg p-6">
                <h3 class="font-bold text-xl mb-3 flex items-center"><i
                    class="fas fa-star text-yellow-400 mr-3"></i>核心优势 (金手指)</h3>
                <div class="grid sm:grid-cols-2 gap-4 text-gray-300">
                  <div class="flex items-start"><i
                      class="fas fa-check-circle text-green-500 mt-1 mr-2"></i><span><b>洄潮屿认可:</b>
                      与岛屿生态系统共生，不受主动攻击。</span></div>
                  <div class="flex items-start"><i
                      class="fas fa-seedling text-lime-500 mt-1 mr-2"></i><span><b>息壤灵田:</b> 掌握顶级灵植培育基地，资源自给自足。</span>
                  </div>
                  <div class="flex items-start"><i
                      class="fas fa-box-open text-cyan-500 mt-1 mr-2"></i><span><b>洋流漂流物:</b> 持续获取外部世界功法、材料的随机盲盒。</span>
                  </div>
                  <div class="flex items-start"><i class="fas fa-brain text-purple-500 mt-1 mr-2"></i><span><b>现代知识:</b>
                      拥有系统科学理论，提供独特解题视角。</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 自定义开局内容 -->
      <div id="custom-start" class="tab-content">
        <div class="relative rounded-xl overflow-hidden p-6 sm:p-8 md:p-12 bg-gray-900">
          <div class="relative z-10 prose-custom max-w-none">
            <h2 class="text-2xl sm:text-3xl font-bold">天赋与家世</h2>
            <p class="text-gray-300">你将有10点天赋点，自由分配在以下各项中，以决定你的开局。这将影响你的初始资源、功法、以及可能遇到的奇遇。</p>

            <div class="mt-8 md:mt-10 space-y-8 md:space-y-12">
              <!-- 海岛环境 -->
              <details class="collapsible-section" open>
                <summary class="font-bold text-lg sm:text-xl mb-4 cursor-pointer">海岛环境 (选择恶劣环境可获得<span class="text-yellow-400">额外点数</span>)</summary>
                <div id="environments-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mt-4">
                  <!-- 环境选项将由JS动态填充 -->
                </div>
              </details>

              <!-- 穿越者心态 -->
              <details class="collapsible-section" open>
                <summary class="font-bold text-lg sm:text-xl mb-4 cursor-pointer">穿越者心态 (选择你的初始目标)</summary>
                <div id="mindsets-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mt-4">
                  <!-- 心态选项将由JS动态填充 -->
                </div>
              </details>

              <!-- 凡人根基 -->
              <details class="collapsible-section" open>
                <summary class="font-bold text-lg sm:text-xl mb-4 cursor-pointer">凡人根基</summary>
                <div class="grid md:grid-cols-3 gap-4 mt-4">
                  <div class="card rounded-lg p-4 border border-green-700 bg-green-900/30">
                      <span class="font-semibold text-green-300">固定背景：农学世家</span>
                      <p class="text-xs text-gray-400 mt-1">你出身于农业世家，对植物的习性有天生的亲和力。</p>
                  </div>
                  <div id="traits-container" class="md:col-span-2">
                    <!-- 可选特长将由JS动态填充 -->
                  </div>
                </div>
              </details>

              <!-- 属性分配 -->
              <details class="collapsible-section" open>
                <summary class="font-bold text-lg sm:text-xl mb-4 cursor-pointer">
                  天赋分配 (剩余天赋点: <span id="points-talent-remaining" class="text-blue-400 font-bold">10</span> / <span class="text-gray-400">10</span>)
                </summary>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 md:gap-6 mt-4">
                  <!-- 根骨 -->
                  <div class="card rounded-lg p-6">
                    <label for="talent-gen-gu" class="font-semibold text-gray-200 flex items-center justify-between">
                      <span><i class="fas fa-bone text-yellow-400 mr-2"></i>根骨</span>
                      <span id="talent-gen-gu-value" class="text-lg font-bold text-blue-400">0</span>
                    </label>
                    <p class="text-sm text-gray-400 mt-1 mb-3">影响你的修炼速度与肉身强度。</p>
                    <input id="talent-gen-gu" type="range" min="0" max="10" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer talent-slider">
                  </div>
                  <!-- 悟性 -->
                  <div class="card rounded-lg p-6">
                    <label for="talent-wu-xing" class="font-semibold text-gray-200 flex items-center justify-between">
                      <span><i class="fas fa-brain text-purple-400 mr-2"></i>悟性</span>
                      <span id="talent-wu-xing-value" class="text-lg font-bold text-blue-400">0</span>
                    </label>
                    <p class="text-sm text-gray-400 mt-1 mb-3">决定你领悟功法、破解禁制的能力。</p>
                    <input id="talent-wu-xing" type="range" min="0" max="10" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer talent-slider">
                  </div>
                  <!-- 气运 -->
                  <div class="card rounded-lg p-6">
                    <label for="talent-qi-yun" class="font-semibold text-gray-200 flex items-center justify-between">
                      <span><i class="fas fa-clover text-green-400 mr-2"></i>气运</span>
                      <span id="talent-qi-yun-value" class="text-lg font-bold text-blue-400">0</span>
                    </label>
                    <p class="text-sm text-gray-400 mt-1 mb-3">影响你遇到奇遇、拾取宝物的概率。</p>
                    <input id="talent-qi-yun" type="range" min="0" max="10" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer talent-slider">
                  </div>
                </div>
              </details>

              <!-- 物品选择 -->
              <details class="collapsible-section" open>
                <summary class="font-bold text-lg sm:text-xl mb-4 cursor-pointer">物品选择</summary>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 mt-4">
                  <!-- 背包/仓库 (修仙物品) -->
                  <div>
                    <h3 class="font-bold text-base mb-2">背包/仓库 (仙缘点: <span id="points-inventory-remaining" class="text-green-400 font-bold">5</span> / <span class="text-gray-400">5</span>)</h3>
                    <div class="card rounded-lg p-4 sm:p-6">
                      <p class="text-sm text-gray-400 mt-1 mb-3">选择你初始获得的修仙界物品。</p>
                      <div id="inventory-items-container" class="space-y-3 max-h-60 sm:max-h-72 overflow-y-auto pr-2">
                        <!-- 修仙物品将由JS动态填充 -->
                      </div>
                    </div>
                  </div>
                  
                  <!-- 帆布包 (地球物品) -->
                  <div>
                    <h3 class="font-bold text-base mb-2">帆布包 (遗物点: <span id="points-bag-remaining" class="text-cyan-400 font-bold">5</span> / <span class="text-gray-400">5</span>)</h3>
                    <div class="card rounded-lg p-4 sm:p-6">
                      <p class="text-sm text-gray-400 mt-1 mb-3">选择额外的个人物品。包内默认已有：<span class="text-gray-300 font-semibold">没电的手机、一套换洗衣物</span>。</p>
                      <div id="bag-items-container" class="space-y-3 max-h-60 sm:max-h-72 overflow-y-auto pr-2">
                        <!-- 地球物品将由JS动态填充 -->
                      </div>
                    </div>
                  </div>
                </div>
              </details>

              <!-- 点数总览 -->
              <div class="text-center p-4 card rounded-lg">
                <h3 class="font-bold text-lg">点数总览</h3>
                <p class="text-sm text-gray-400">所有超出基础点数的消耗，将从环境提供的 <span class="text-yellow-400">额外点数</span> 中扣除。</p>
                <p class="text-lg mt-2">可用额外点数: <span id="points-extra-remaining" class="text-yellow-400 font-bold">0</span></p>
              </div>

              <!-- 确认按钮 -->
              <div class="text-center flex justify-center items-center space-x-4">
                <button id="load-previous-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                  <i class="fas fa-history mr-2"></i>读取上次
                </button>
                <button id="confirm-start-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
                  <i class="fas fa-check-circle mr-2"></i>确认开局
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer class="text-center mb-16 prose-custom">
      <p class="mt-4 text-lg text-gray-400">完成开局设定后切换消息页以开始游玩</p>
    </footer>
  </div>

<script>
// --- 数据定义 ---

const environments = [
    { id: 'env-easy', name: '风调雨顺', description: '海岛气候温和，资源丰富，拥有稳定的淡水和食物来源。', extraPoints: 0 },
    { id: 'env-medium', name: '暗流涌动', description: '天气多变，部分水源被污染，你需要花费更多精力寻找食物。', extraPoints: 3 },
    { id: 'env-hard', name: '绝地天通', description: '灵气稀薄且狂暴，生存维艰，你甚至会持续感到虚弱。', extraPoints: 6 },
];

const mindsets = [
    { id: 'mindset-survivor', name: '求生者', description: '活下去是不变的真理。你对环境中的危险和机遇有更强的直觉。' },
    { id: 'mindset-explorer', name: '探究者', description: '解析世界是最大的乐趣。你更容易从未知事物中获得感悟。' },
    { id: 'mindset-returner', name: '归乡者', description: '这里只是垫脚石。你对空间、星辰相关的线索有特殊感应。' },
];

const defaultTrait = { id: 'trait-farmer', name: '农学世家', description: '你出身于农业世家，对植物的习性有天生的亲和力。' };
const optionalTraits = [
    { id: 'trait-athlete', name: '运动健将', description: '你曾是运动健将，拥有更强的体能和耐力。' },
    { id: 'trait-handy', name: '动手达人', description: '你热爱手工，能更快地制作和修复工具。' },
    { id: 'trait-none', name: '无', description: '你没有其他特别的凡人特长。' },
];

const inventoryItems = [
  { id: 'item-chang-chun-jue', name: '《长春诀》拓本', description: '一部完整的炼气期木系功法，中正平和。', points: 4 },
  { id: 'item-cao-mu-tu-jian', name: '《元初草木图鉴》残本', description: '记录了大量海滨灵植的图鉴，灵植师的宝贵参考。', points: 3 },
  { id: 'item-pigu-dan', name: '一瓶辟谷丹', description: '十颗装，让你在前期无需为食物发愁。', points: 2 },
  { id: 'item-duan-jian', name: '断裂的飞剑（剑尖）', description: '由青玉精钢制成，可打造成锋利的小刀或箭头。', points: 2 },
  { id: 'item-chu-wu-dai', name: '失效的储物袋', description: '空间已失，但可研究其符文结构，有修复的可能。', points: 2 },
];

const bagItems = [
  { id: 'item-solar-charger', name: '太阳能充电器', description: '一块折叠式太阳能充电板，或许能让你那块板砖重新开机。', points: 5 },
  { id: 'item-multi-tool', name: '多功能军刀', description: '瑞士军刀，集成了小刀、锯子、开罐器等多种工具。', points: 3 },
  { id: 'item-antibiotics', name: '广谱抗生素', description: '一小瓶阿莫西林，用于紧急情况下的抗感染治疗。', points: 3 },
  { id: 'item-seeds', name: '高产作物种子', description: '一小包精选的杂交水稻和土豆种子。', points: 2 },
  { id: 'item-fire-starter', name: '打火石', description: '镁条打火石，在潮湿环境下也能生火。', points: 2 },
  { id: 'item-fish-line', name: '高强度鱼线和鱼钩', description: '专业的钓鱼工具，让你更容易获取食物。', points: 1 },
];

const defaultBagItems = ['没电的手机', '一套换洗衣物'];

// --- Tab 功能 ---
function showTab(tabId) {
  $('.tab-content, .tab-button').removeClass('active');
  $(`#${tabId}, [data-tab="${tabId}"]`).addClass('active');
}

function initializeTabs() {
  $('.tab-button').on('click', function() {
    const tabId = $(this).data('tab');
    if (tabId) showTab(tabId);
  });
}

// --- 渲染函数 ---
function renderOptions(containerId, items, type, name, pointClass) {
    const container = $(`#${containerId}`);
    if (!container.length) return;
    let html = '';
    items.forEach((item, index) => {
        const hasPoints = item.points !== undefined || item.extraPoints !== undefined;
        const pointValue = item.points !== undefined ? `+${item.points}点` : `+${item.extraPoints}额外点数`;
        const pointText = hasPoints ? `<span class="${pointClass} font-bold">(${pointValue})</span>` : '';

        html += `
            <div class="card rounded-lg p-4 border border-gray-700 hover:border-purple-500 transition">
                <label for="${item.id}" class="flex items-start cursor-pointer">
                    <input type="${type}" id="${item.id}" name="${name}" value="${item.points || item.extraPoints || 0}" class="${name}-input mt-1 mr-3 h-4 w-4" ${type === 'radio' && index === 0 ? 'checked' : ''}>
                    <div>
                        <span class="font-semibold text-gray-200">${item.name}</span>
                        ${pointText}
                        <p class="text-xs text-gray-400 mt-1">${item.description}</p>
                    </div>
                </label>
            </div>`;
    });
    container.html(html);
}

function renderItems(containerId, items, itemClass) {
  const container = $(`#${containerId}`);
  if (!container.length) return;
  let html = '';
  items.forEach(item => {
    html += `
      <div class="item-card p-3 rounded-lg border border-gray-700 hover:border-blue-500 transition">
        <label for="${item.id}" class="flex items-start cursor-pointer">
          <input type="checkbox" id="${item.id}" data-points="${item.points}" class="${itemClass} mt-1 mr-3 h-4 w-4 rounded bg-gray-800 border-gray-600 text-blue-500 focus:ring-blue-600">
          <div>
            <span class="font-semibold text-gray-200">${item.name}</span>
            <span class="text-yellow-400 font-bold">(-${item.points}点)</span>
            <p class="text-xs text-gray-400 mt-1">${item.description}</p>
          </div>
        </label>
      </div>`;
  });
  container.html(html);
}

// --- 自定义开局主逻辑 ---
function initializeCustomStart() {
  const UIElements = {
    sliders: $('.talent-slider'),
    confirmButton: $('#confirm-start-button'),
    loadPreviousButton: $('#load-previous-button'),
    points: {
      talentRemaining: $('#points-talent-remaining'),
      inventoryRemaining: $('#points-inventory-remaining'),
      bagRemaining: $('#points-bag-remaining'),
      extraRemaining: $('#points-extra-remaining'),
    },
  };

  const basePoints = { talent: 10, inventory: 5, bag: 5 };

  function updatePoints() {
    // 1. 计算花费
    let talentSpent = 0;
    UIElements.sliders.each(function() {
      const val = parseInt($(this).val(), 10);
      talentSpent += val;
      $(`#${this.id}-value`).text(val);
    });
    let inventorySpent = 0;
    $('.inventory-item-checkbox:checked').each(function() {
      inventorySpent += parseInt($(this).data('points'), 10);
    });
    let bagSpent = 0;
    $('.bag-item-checkbox:checked').each(function() {
      bagSpent += parseInt($(this).data('points'), 10);
    });

    // 2. 计算剩余与超支
    const talentLeft = basePoints.talent - talentSpent;
    const inventoryLeft = basePoints.inventory - inventorySpent;
    const bagLeft = basePoints.bag - bagSpent;
    
    // 3. 获取额外点数
    const extraPoints = parseInt($('input[name="environment"]:checked').val(), 10);
    const totalOverdraft = Math.max(0, -talentLeft) + Math.max(0, -inventoryLeft) + Math.max(0, -bagLeft);
    const finalExtraLeft = extraPoints - totalOverdraft;

    // 4. 更新UI
    UIElements.points.talentRemaining.text(talentLeft);
    UIElements.points.inventoryRemaining.text(inventoryLeft);
    UIElements.points.bagRemaining.text(bagLeft);
    UIElements.points.extraRemaining.text(finalExtraLeft);

    // 5. 处理UI警告和按钮状态
    $('.font-bold').removeClass('text-red-500');
    if (finalExtraLeft < 0) {
      UIElements.confirmButton.prop('disabled', true);
      UIElements.points.extraRemaining.addClass('text-red-500');
      if (talentLeft < 0) UIElements.points.talentRemaining.addClass('text-red-500');
      if (inventoryLeft < 0) UIElements.points.inventoryRemaining.addClass('text-red-500');
      if (bagLeft < 0) UIElements.points.bagRemaining.addClass('text-red-500');
    } else {
      UIElements.confirmButton.prop('disabled', false);
    }
  }

  // 初始化渲染
  renderOptions('environments-container', environments, 'radio', 'environment', 'text-yellow-400');
  renderOptions('mindsets-container', mindsets, 'radio', 'mindset', 'text-gray-500');
  renderOptions('traits-container', optionalTraits, 'radio', 'trait', 'text-gray-500');
  renderItems('inventory-items-container', inventoryItems, 'inventory-item-checkbox');
  renderItems('bag-items-container', bagItems, 'bag-item-checkbox');
  
  // 绑定事件
  $('input').on('change input', updatePoints);

  // --- 读取上次设定 ---
  async function loadPreviousSettings() {
    const bookName = "什么？我要在玄幻修仙世界种田？";
    const entryKey = "自定义开局";
    toastr.info('正在读取上次的开局设定...');

    try {
      const worldbook = await getWorldbook(bookName);
      const entry = worldbook.find(e => e.name === entryKey);
      const worldbookContent = entry?.content;

      if (worldbookContent) {
        parseAndApplySettings(worldbookContent);
        updatePoints(); // 更新点数显示
        toastr.success('已成功加载上次的开局设定！');
        //console.log("已成功加载上次的开局设定:",worldbookContent);
      } else {
        toastr.warning('未找到上次的开局设定。');
      }
    } catch (error) {
      console.error('读取世界书失败:', error);
      toastr.error('读取设定失败，请查看控制台。');
    }
  }

  function parseAndApplySettings(content) {
    const getVal = (regex) => content.match(regex)?.[1].trim() || null;

    // 环境
    const envName = getVal(/- \*\*【环境】(.*?)\*\*:/);
    const envData = environments.find(e => e.name === envName);
    if (envData) $(`#${envData.id}`).prop('checked', true);

    // 心态
    const mindsetName = getVal(/- \*\*【心态】(.*?)\*\*:/);
    const mindsetData = mindsets.find(m => m.name === mindsetName);
    if (mindsetData) $(`#${mindsetData.id}`).prop('checked', true);

    // 天赋
    const genGu = getVal(/-\s*\*\*根骨\*\*:\s*(\d+)\/10/);
    const wuXing = getVal(/-\s*\*\*悟性\*\*:\s*(\d+)\/10/);
    const qiYun = getVal(/-\s*\*\*气运\*\*:\s*(\d+)\/10/);
    if (genGu) {
      $('#talent-gen-gu').val(genGu);
      $('#talent-gen-gu-value').text(genGu);
    }
    if (wuXing) {
      $('#talent-wu-xing').val(wuXing);
      $('#talent-wu-xing-value').text(wuXing);
    }
    if (qiYun) {
      $('#talent-qi-yun').val(qiYun);
      $('#talent-qi-yun-value').text(qiYun);
    }

    // 特长
    const traitsBlock = getVal(/- \*\*【凡人特长】\*\*:\s*([\s\S]*?)(?=\n\s*- \*\*【修仙天赋】|$)/);
    const selectedTrait = optionalTraits.find(t => traitsBlock?.includes(`**${t.name}**`));
    $(`input[name="trait"]`).prop('checked', false);
    if (selectedTrait && selectedTrait.id !== 'trait-none') {
      $(`#${selectedTrait.id}`).prop('checked', true);
    } else {
      $('#trait-none').prop('checked', true);
    }

    // 物品
    const inventoryBlock = getVal(/- \*\*【修仙者行囊】\*\*:\s*([\s\S]*?)(?=\n- \*\*【穿越者帆布包】|$)/);
    const bagBlock = getVal(/- \*\*【穿越者帆布包】\*\*:\s*([\s\S]*)/);

    $('.inventory-item-checkbox, .bag-item-checkbox').prop('checked', false);
    inventoryItems.forEach(item => {
      if (inventoryBlock?.includes(`**${item.name}**`)) $(`#${item.id}`).prop('checked', true);
    });
    bagItems.forEach(item => {
      if (bagBlock?.includes(`**${item.name}**`)) $(`#${item.id}`).prop('checked', true);
    });
  }

  UIElements.loadPreviousButton.on('click', loadPreviousSettings);

  // 确认按钮逻辑
  UIElements.confirmButton.on('click', async () => {
    updatePoints();
    if (UIElements.confirmButton.is(':disabled')) {
      toastr.error('点数分配超出上限！');
      return;
    }

    const getSelectionData = (selector, collection) => {
      const selectedId = $(selector).attr('id');
      return collection.find(item => item.id === selectedId) || null;
    };
    const getSelectionsData = (selector, collection) => {
      const selectedIds = $(selector).map((_, el) => $(el).attr('id')).get();
      return collection.filter(item => selectedIds.includes(item.id));
    };

    const selectedEnv = getSelectionData('input[name="environment"]:checked', environments);
    const selectedMindset = getSelectionData('input[name="mindset"]:checked', mindsets);
    const selectedTrait = getSelectionData('input[name="trait"]:checked', optionalTraits);

    const finalTraits = [defaultTrait];
    if (selectedTrait && selectedTrait.id !== 'trait-none') {
        finalTraits.push(selectedTrait);
    }

    const selections = {
      env: selectedEnv,
      mindset: selectedMindset,
      traits: finalTraits,
      talents: {
        genGu: $('#talent-gen-gu').val(),
        wuXing: $('#talent-wu-xing').val(),
        qiYun: $('#talent-qi-yun').val(),
      },
      inventory: getSelectionsData('.inventory-item-checkbox:checked', inventoryItems),
      bag: getSelectionsData('.bag-item-checkbox:checked', bagItems),
    };

    // 构建更详细、结构化的条目内容
    let entryContent = `
# 玩家自定义开局设定
以下是玩家为本次游戏选择的初始配置，请在后续的剧情生成中严格参考这些设定。

## 核心设定
- **【环境】${selections.env?.name}**: ${selections.env?.description}
- **【心态】${selections.mindset?.name}**: ${selections.mindset?.description}

## 天赋根基
- **【凡人特长】**: 
${selections.traits.map(t => `  - **${t.name}**: ${t.description}`).join('\n')}
- **【修仙天赋】**:
  - **根骨**: ${selections.talents.genGu}/10
  - **悟性**: ${selections.talents.wuXing}/10
  - **气运**: ${selections.talents.qiYun}/10

## 初始携带
- **【修仙者行囊】**:
${selections.inventory.length > 0 ? selections.inventory.map(item => `  - **${item.name}**: ${item.description}`).join('\n') : '  - 无'}
- **【穿越者帆布包】**:
${[...defaultBagItems.map(name => `  - ${name}`), ...selections.bag.map(item => `  - **${item.name}**: ${item.description}`)].join('\n')}
`.trim();

    const bookName = "什么？我要在玄幻修仙世界种田？";
    const entryKey = "自定义开局";

    try {
      await updateWorldbookWith(bookName, (worldbook) => {
        const entryIndex = worldbook.findIndex(entry => entry.name === entryKey);

        if (entryIndex !== -1) {
          // 更新现有条目
          worldbook[entryIndex].content = entryContent;
          toastr.success('自定义开局已更新！', '设置已保存');
        } else {
          // 创建新条目
          worldbook.push({
            name: entryKey,
            content: entryContent,
            enabled: true,
            strategy: {
              type: 'constant',
              keys: [],
              keys_secondary: { logic: 'and_any', keys: [] },
              scan_depth: 'same_as_global',
            },
            position: {
              type: 'before_character_definition',
              role: 'system',
              depth: 4,
              order: 0,
            },
            probability: 100,
            recursion: {
              prevent_incoming: false,
              prevent_outgoing: false,
              delay_until: null,
            },
            effect: {
              sticky: null,
              cooldown: null,
              delay: null,
            },
          });
          toastr.success('自定义开局成功！', '设置已保存');
        }
        return worldbook;
      });

      UIElements.confirmButton.text('已确认').prop('disabled', true);
      $('input').prop('disabled', true);

      // Call the new function to update the first message's second swipe
      await updateFirstMessageSwipeWithItems(entryContent);

    } catch (error) {
      console.error('操作世界书条目或更新首楼消息失败:', error);
      toastr.error('自定义开局失败，请检查控制台日志。', '错误');
    }
  });

  updatePoints(); // 初始计算
}

// DOM加载完成后执行
$(() => {
  initializeTabs();
  initializeCustomStart();

  // On mobile, close all collapsible sections by default
  if (window.innerWidth < 768) {
    $('.collapsible-section').removeAttr('open');
  }
});

async function updateFirstMessageSwipeWithItems(worldbookContent) {
  try {
    // 1. 从世界书内容中解析物品
    const inventoryRegex = /-\s\*\*【修仙者行囊】\*\*:\s*([\s\S]*?)(?=\n- \*\*【穿越者帆布包】\*\*|$)/;
    const bagRegex = /-\s\*\*【穿越者帆布包】\*\*:\s*([\s\S]*)/;

    const inventoryMatch = worldbookContent.match(inventoryRegex);
    const bagMatch = worldbookContent.match(bagRegex);

    const parseSelectedItems = (match) => {
      if (!match || !match[1] || match[1].trim().includes('无')) return [];
      return match[1]
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.startsWith('- **')) // 只匹配玩家选择的加粗项目
        .map(line => {
            let itemName = line.replace(/^- \*\*/, '').split('**:')[0].trim();
            return `🎒 ${itemName}`;
        });
    };

    const inventoryItems = parseSelectedItems(inventoryMatch);

    // 从旅行包部分解析所有物品（包括默认和选择的）
    const allBagItems = [];
    if (bagMatch && bagMatch[1]) {
      const itemLines = bagMatch[1].split('\n').map(line => line.trim()).filter(line => line.startsWith('- '));
      for (const line of itemLines) {
        if (line.startsWith('- **')) {
          // 玩家选择的物品
          const itemName = line.replace(/^- \*\*/, '').split('**:')[0].trim();
          allBagItems.push(`🎒 ${itemName}`);
        } else {
          // 默认物品
          const itemName = line.replace(/^-/, '').trim();
          allBagItems.push(`🎒 - ${itemName}`);
        }
      }
    }

    // 2. 构建新的、结构正确的物品列表
    const allItems = [
      ...inventoryItems,
      '👜 【穿越者帆布包】',
      ...allBagItems,
    ];

    // 2. 获取首楼的所有消息页
    const firstMessageSwipes = getChatMessages(0, { include_swipes: true })[0];
    if (!firstMessageSwipes || !firstMessageSwipes.swipes || firstMessageSwipes.swipes.length < 2) {
      toastr.error('无法获取到首楼的第二个消息页（游戏开局页）。');
      return;
    }

    const gameStartSwipeContent = firstMessageSwipes.swipes[1];

    // 3. 使用 jQuery 解析第二个消息页的HTML内容
    const $parsedContent = $(`<div>${gameStartSwipeContent}</div>`);
    const $statusBar = $parsedContent.find('statusbar'); // jQuery is case-insensitive for tag names

    if ($statusBar.length === 0) {
        toastr.error('游戏开局页中未找到 <statusbar> 标签。');
        return;
    }
    const statusBarJsonContent = $statusBar.text().trim();

    let statusBarData;
    try {
      statusBarData = JSON.parse(statusBarJsonContent);
    } catch (e) {
      toastr.error('解析游戏开局页中 <statusbar> 内的JSON失败。');
      console.error("JSON Parsing Error:", e, "Content:", statusBarJsonContent);
      return;
    }

    // 4. 更新核心物品 (使用更稳健的查找方式)
    const rootKey = Object.keys(statusBarData)[0];
    const characterList = statusBarData[rootKey]['角色列表'];
    if (characterList && Array.isArray(characterList) && characterList.length > 0) {
        const mainCharacter = characterList[0]['👤 角色'];
        if (mainCharacter) {
            mainCharacter['🎒 核心物品'] = allItems;
        }
    }

    // 5. 构建新的消息页数组并保存
    const updatedJsonString = JSON.stringify(statusBarData, null, 2);
    const updatedSwipeContent = gameStartSwipeContent.replace(statusBarRegex, `<StatusBar>\n${updatedJsonString}\n</StatusBar>`);

    const newSwipes = [...firstMessageSwipes.swipes];
    newSwipes[1] = updatedSwipeContent;

    await setChatMessages([{ message_id: 0, swipes: newSwipes }], { refresh: 'none' });

    toastr.success('已成功更新游戏开局的核心物品！');

  } catch (error) {
    console.error('更新游戏开局消息失败:', error);
    toastr.error('更新游戏开局状态失败，请查看控制台。');
  }
}
</script>
</body>
