<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apexæ¨¡å‹èƒ½åŠ›æµ‹è¯• - äº’åŠ¨å°è¯´å¼€ç¯‡ (Test)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&display=swap');

    body {
      font-family: 'Inter', 'Noto Serif SC', serif;
      background-color: #111827;
      /* æ·±ç°è“èƒŒæ™¯ */
      color: #E5E7EB;
      /* æµ…ç°è‰²æ–‡å­— */
    }

    .prose-custom h1,
    .prose-custom h2,
    .prose-custom h3 {
      font-family: 'Noto Serif SC', serif;
      color: #F9FAFB;
      /* ç™½è‰²æ ‡é¢˜ */
      border-left: 4px solid #3B82F6;
      /* è“è‰²å·¦è¾¹æ¡† */
      padding-left: 1rem;
    }

    .card {
      background-color: rgba(30, 41, 59, 0.5);
      /* åŠé€æ˜æ·±è“ç°è‰²èƒŒæ™¯ */
      backdrop-filter: blur(10px);
      border: 1px solid rgba(55, 65, 81, 0.5);
      transition: all 0.3s ease-in-out;
    }

    .card:hover {
      border-color: #3B82F6;
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.1), 0 4px 6px -2px rgba(59, 130, 246, 0.05);
    }

    .tag {
      background-color: #374151;
      /* æ·±ç°è‰²æ ‡ç­¾ */
      color: #D1D5DB;
      /* ç°è‰²æ–‡å­— */
    }

    .world-bg {
      background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?q=80&w=2071&auto=format&fit=crop');
      background-size: cover;
      background-position: center;
      position: relative;
    }

    .world-bg::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to top, #111827, rgba(17, 24, 39, 0.7));
    }

    .char-bg {
      background-image: url('https://images.unsplash.com/photo-1544716278-e513176f20b5?q=80&w=1974&auto=format&fit=crop');
      background-size: cover;
      background-position: center;
      position: relative;
    }

    .char-bg::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to top, #111827, rgba(17, 24, 39, 0.7));
    }

    .tab-button {
      transition: all 0.3s ease;
    }

    .tab-button.active {
      background-color: #3B82F6;
      color: #F9FAFB;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.5s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .prose-custom h1,
      .prose-custom h2,
      .prose-custom h3 {
        padding-left: 0.75rem;
        border-left-width: 3px;
      }

      .card {
        padding: 1rem;
      }
    }

    @media (max-width: 640px) {
      .tab-button {
        padding: 0.5rem 0.25rem;
        font-size: 0.8rem;
      }

      .tab-button .fas {
        margin-right: 0.25rem;
      }
    }

    /* Collapsible sections */
    .collapsible-section summary {
      position: relative;
      padding-right: 2rem; /* Space for the icon */
    }

    .collapsible-section summary::after {
      content: '\f078'; /* Font Awesome chevron-down */
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%) rotate(0deg);
      transition: transform 0.3s ease;
    }

    .collapsible-section[open] > summary::after {
      transform: translateY(-50%) rotate(180deg);
    }

    /* On mobile, collapse sections by default */
    @media (max-width: 768px) {
      .collapsible-section {
        border-bottom: 1px solid rgba(55, 65, 81, 0.5);
        padding-bottom: 1rem;
        margin-bottom: 1rem;
      }
      .collapsible-section:not([open]) {
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
      }
      .collapsible-section[open] {
        padding-bottom: 1.5rem;
      }
      .collapsible-section:last-of-type {
        border-bottom: none;
      }
      .collapsible-section > summary {
        margin-bottom: 0;
      }
      .collapsible-section:not([open]) > *:not(summary) {
          display: none;
      }
    }

    /* Custom Scrollbar */
    #inventory-items-container::-webkit-scrollbar,
    #bag-items-container::-webkit-scrollbar {
      width: 8px;
    }

    #inventory-items-container::-webkit-scrollbar-track,
    #bag-items-container::-webkit-scrollbar-track {
      background: rgba(30, 41, 59, 0.5);
      border-radius: 10px;
    }

    #inventory-items-container::-webkit-scrollbar-thumb,
    #bag-items-container::-webkit-scrollbar-thumb {
      background-color: #3B82F6;
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: content-box;
    }

    #inventory-items-container::-webkit-scrollbar-thumb:hover,
    #bag-items-container::-webkit-scrollbar-thumb:hover {
      background-color: #2563EB;
    }
  </style>
</head>

<body class="antialiased">

  <div class="container mx-auto px-4 py-12 max-w-7xl">

    <!-- æ ‡é¢˜åŒºåŸŸ -->
    <header class="text-center mb-12 md:mb-16 prose-custom">
      <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold tracking-tight">ä»€ä¹ˆï¼Ÿæˆ‘è¦åœ¨ç„å¹»ä¿®ä»™ä¸–ç•Œç§ç”°ï¼Ÿ</h1>
      <p class="mt-4 text-base md:text-lg text-gray-400">ç‰ˆæœ¬:
        v0.1</p>
      <p class="mt-4 text-xs md:text-sm text-gray-400">ä½œè€…ï¼šgoddess_boreas</p>
    </header>

    <!-- Tab åˆ‡æ¢æŒ‰é’® -->
    <div class="flex justify-center mb-8 space-x-2 md:space-x-4 bg-gray-800 rounded-lg p-2 max-w-md mx-auto">
      <button data-tab="worldview"
        class="tab-button flex-1 py-2 px-4 rounded-md text-sm md:text-base font-medium active"><i
          class="fas fa-globe-asia mr-2"></i>ä¸–ç•Œè§‚é€Ÿè§ˆ</button>
      <button data-tab="character"
        class="tab-button flex-1 py-2 px-4 rounded-md text-sm md:text-base font-medium"><i
          class="fas fa-user-circle mr-2"></i>è§’è‰²æ¡£æ¡ˆ</button>
      <button data-tab="custom-start"
        class="tab-button flex-1 py-2 px-4 rounded-md text-sm md:text-base font-medium"><i
          class="fas fa-dice mr-2"></i>è‡ªå®šä¹‰å¼€å±€</button>
    </div>

    <!-- Tab å†…å®¹åŒºåŸŸ -->
    <main>
      <!-- ä¸–ç•Œè§‚å†…å®¹ -->
      <div id="worldview" class="tab-content active">
        <div class="relative rounded-xl overflow-hidden p-6 sm:p-8 md:p-12 world-bg">
          <div class="relative z-10 prose-custom max-w-none">
            <h2 class="text-2xl sm:text-3xl font-bold">å…ƒåˆç•Œ</h2>
            <p class="text-gray-300">è¿™æ˜¯ä¸€ä¸ªä»¥â€œçµæ°”â€ä¸ºä¸‡ç‰©æœ¬æºä¸å”¯ä¸€ä¿®ç‚¼èƒ½é‡çš„ç„å¹»ä¿®ä»™ä¸–ç•Œã€‚å¤§é“è‡³ç®€ï¼Œä¿®è¡Œè€…ä¸“æ³¨äºâ€œé“â€ä¸â€œæ³•â€çš„æ„Ÿæ‚Ÿï¼Œè€Œéç¹æ‚çš„ç­‰çº§çªç ´ã€‚</p>

            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 mt-8 md:mt-10">
              <!-- å¢ƒç•Œè®¾å®š -->
              <div class="card rounded-lg p-6">
                <h3 class="font-bold text-xl mb-3 flex items-center"><i
                    class="fas fa-layer-group text-blue-400 mr-3"></i>æ ¸å¿ƒå¢ƒç•Œ</h3>
                <ul class="space-y-2 text-gray-400">
                  <li><span class="font-semibold text-gray-200">æ·¬ä½“å¢ƒ:</span> å‡¡èº¯æ‰“ç£¨ï¼Œä»™å‡¡ä¹‹éš”ã€‚</li>
                  <li><span class="font-semibold text-gray-200">ç‚¼æ°”å¢ƒ:</span> å¼•æ°”å…¥ä½“ï¼Œåˆçª¥é—¨å¾„ã€‚</li>
                  <li><span class="font-semibold text-gray-200">ç­‘åŸºå¢ƒ:</span> é“¸å°±é“åŸºï¼Œç¥è¯†åˆé†’ã€‚</li>
                  <li><span class="font-semibold text-gray-200">é‡‘ä¸¹å¢ƒ:</span> ä¸¹æˆå¤§é“ï¼Œå¾¡å™¨é£è¡Œã€‚</li>
                  <li><span class="font-semibold text-gray-200">å…ƒå©´å¢ƒ:</span> å©´å˜ä¸ç­ï¼Œç¬ç§»åƒé‡Œã€‚</li>
                  <li><span class="font-semibold text-gray-200">åŒ–ç¥å¢ƒ:</span> æ³•åˆ™è¨€éšï¼Œç¥æ¸¸å¤ªè™šã€‚</li>
                </ul>
              </div>
              <!-- èŒä¸šä½“ç³» -->
              <div class="card rounded-lg p-6">
                <h3 class="font-bold text-xl mb-3 flex items-center"><i
                    class="fas fa-briefcase text-green-400 mr-3"></i>å¤šå…ƒèŒä¸š</h3>
                <div class="space-y-3">
                  <div>
                    <h4 class="font-semibold text-gray-200">æˆ˜æ–—ç±»</h4>
                    <p class="text-gray-400 text-sm">å‰‘ä¿®ã€æ³•ä¿®ã€ä½“ä¿®ã€é­‚ä¿®</p>
                  </div>
                  <div>
                    <h4 class="font-semibold text-gray-200">è¾…ä½ç±»</h4>
                    <p class="text-gray-400 text-sm">ä¸¹å¸ˆã€å™¨å¸ˆã€é˜µå¸ˆ</p>
                  </div>
                  <div>
                    <h4 class="font-semibold text-gray-200">å¥‡é—¨ç±»</h4>
                    <p class="text-gray-400 text-sm">ç¬¦å¸ˆã€çµæ¤å¸ˆã€å¾¡å…½å¸ˆ</p>
                  </div>
                </div>
              </div>
              <!-- å¼€åœºèˆå° -->
              <div class="card rounded-lg p-6 md:col-span-2 lg:col-span-1">
                <h3 class="font-bold text-xl mb-3 flex items-center"><i
                    class="fas fa-map-marked-alt text-purple-400 mr-3"></i>å¼€åœºèˆå°ï¼šæ´„æ½®å±¿</h3>
                <p class="text-gray-400">ä½äºæ— å¦„æµ·ä¸œéƒ¨ï¼Œæ´‹æµäº¤æ±‡ä¹‹åœ°çš„éšç§˜æ´å¤©ã€‚è¡¨è±¡å¹³å‡¡ï¼Œå†…è—ç„æœºã€‚</p>
                <ul class="mt-3 space-y-2 text-gray-400">
                  <li><i class="fas fa-leaf text-green-500 mr-2"></i><b>æ¯å£¤çµç”°:</b> åŠ é€Ÿçµæ¤ç”Ÿé•¿ï¼Œç‚¹åŒ–å‡¡ç‰©ã€‚</li>
                  <li><i class="fas fa-water text-cyan-500 mr-2"></i><b>æ´‹æµå®åº“:</b> æµ·æ»©éšæœºåˆ·æ–°èµ„æºä¸é—ç‰©ã€‚</li>
                  <li><i class="fas fa-skull-crossbones text-red-500 mr-2"></i><b>æ°´ä¸‹æ€æœº:</b> æ·±æµ·æš—è—å·¨å…½ä¸ä¸Šå¤é—è¿¹ã€‚</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- è§’è‰²æ¡£æ¡ˆå†…å®¹ -->
      <div id="character" class="tab-content">
        <div class="relative rounded-xl overflow-hidden p-6 sm:p-8 md:p-12 char-bg">
          <div class="relative z-10 grid md:grid-cols-3 gap-6 md:gap-8">
            <!-- è§’è‰²åŸºç¡€ä¿¡æ¯ -->
            <div class="md:col-span-1 prose-custom">
              <h2 class="text-2xl sm:text-3xl font-bold">è§’è‰²æ¡£æ¡ˆ</h2>
              <h3 class="text-3xl sm:text-4xl font-serif mt-2" style="color: #60A5FA;">è§æ –é›ª</h3>
              <p class="text-gray-300">"ä¸€ä½æ¥è‡ªå¼‚ä¸–ç•Œçš„å†œä¸šå­¦è€…ï¼Œåœ¨è¿™ç‰‡å……æ»¡çµæ°”çš„åœŸåœ°ä¸Šï¼Œå¼€å§‹äº†å¥¹çš„ç§ç”°ä¿®ä»™ä¹‹æ—…ã€‚"</p>
              <div class="mt-6 space-y-4">
                <div><i class="fas fa-id-card fa-fw mr-3 text-gray-400"></i><span class="font-semibold">èº«ä»½:</span> æ•£ä¿® /
                  çµæ¤å¸ˆ (å‰ä¸–: å†œä¸šå­¦ç”Ÿ)</div>
                <div><i class="fas fa-map-pin fa-fw mr-3 text-gray-400"></i><span class="font-semibold">é˜µè¥:</span> ä¸­ç«‹ /
                  ç§©åº</div>
                <div><i class="fas fa-user-circle fa-fw mr-3 text-gray-400"></i><span class="font-semibold">æ€§æ ¼:</span>
                  è°¨æ…åŠ¡å®ã€èªæ…§åšéŸ§ã€æ¢ç´¢æ¬²å¼º</div>
              </div>
            </div>
            <!-- æ ¸å¿ƒè®¾å®šä¸ç‰©å“ -->
            <div class="md:col-span-2 space-y-6">
              <!-- æ ¸å¿ƒä¼˜åŠ¿ -->
              <div class="card rounded-lg p-6">
                <h3 class="font-bold text-xl mb-3 flex items-center"><i
                    class="fas fa-star text-yellow-400 mr-3"></i>æ ¸å¿ƒä¼˜åŠ¿ (é‡‘æ‰‹æŒ‡)</h3>
                <div class="grid sm:grid-cols-2 gap-4 text-gray-300">
                  <div class="flex items-start"><i
                      class="fas fa-check-circle text-green-500 mt-1 mr-2"></i><span><b>æ´„æ½®å±¿è®¤å¯:</b>
                      ä¸å²›å±¿ç”Ÿæ€ç³»ç»Ÿå…±ç”Ÿï¼Œä¸å—ä¸»åŠ¨æ”»å‡»ã€‚</span></div>
                  <div class="flex items-start"><i
                      class="fas fa-seedling text-lime-500 mt-1 mr-2"></i><span><b>æ¯å£¤çµç”°:</b> æŒæ¡é¡¶çº§çµæ¤åŸ¹è‚²åŸºåœ°ï¼Œèµ„æºè‡ªç»™è‡ªè¶³ã€‚</span>
                  </div>
                  <div class="flex items-start"><i
                      class="fas fa-box-open text-cyan-500 mt-1 mr-2"></i><span><b>æ´‹æµæ¼‚æµç‰©:</b> æŒç»­è·å–å¤–éƒ¨ä¸–ç•ŒåŠŸæ³•ã€ææ–™çš„éšæœºç›²ç›’ã€‚</span>
                  </div>
                  <div class="flex items-start"><i class="fas fa-brain text-purple-500 mt-1 mr-2"></i><span><b>ç°ä»£çŸ¥è¯†:</b>
                      æ‹¥æœ‰ç³»ç»Ÿç§‘å­¦ç†è®ºï¼Œæä¾›ç‹¬ç‰¹è§£é¢˜è§†è§’ã€‚</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- è‡ªå®šä¹‰å¼€å±€å†…å®¹ -->
      <div id="custom-start" class="tab-content">
        <div class="relative rounded-xl overflow-hidden p-6 sm:p-8 md:p-12 bg-gray-900">
          <div class="relative z-10 prose-custom max-w-none">
            <h2 class="text-2xl sm:text-3xl font-bold">å¤©èµ‹ä¸å®¶ä¸–</h2>
            <p class="text-gray-300">ä½ å°†æœ‰10ç‚¹å¤©èµ‹ç‚¹ï¼Œè‡ªç”±åˆ†é…åœ¨ä»¥ä¸‹å„é¡¹ä¸­ï¼Œä»¥å†³å®šä½ çš„å¼€å±€ã€‚è¿™å°†å½±å“ä½ çš„åˆå§‹èµ„æºã€åŠŸæ³•ã€ä»¥åŠå¯èƒ½é‡åˆ°çš„å¥‡é‡ã€‚</p>

            <div class="mt-8 md:mt-10 space-y-8 md:space-y-12">
              <!-- æµ·å²›ç¯å¢ƒ -->
              <details class="collapsible-section" open>
                <summary class="font-bold text-lg sm:text-xl mb-4 cursor-pointer">æµ·å²›ç¯å¢ƒ (é€‰æ‹©æ¶åŠ£ç¯å¢ƒå¯è·å¾—<span class="text-yellow-400">é¢å¤–ç‚¹æ•°</span>)</summary>
                <div id="environments-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mt-4">
                  <!-- ç¯å¢ƒé€‰é¡¹å°†ç”±JSåŠ¨æ€å¡«å…… -->
                </div>
              </details>

              <!-- ç©¿è¶Šè€…å¿ƒæ€ -->
              <details class="collapsible-section" open>
                <summary class="font-bold text-lg sm:text-xl mb-4 cursor-pointer">ç©¿è¶Šè€…å¿ƒæ€ (é€‰æ‹©ä½ çš„åˆå§‹ç›®æ ‡)</summary>
                <div id="mindsets-container" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mt-4">
                  <!-- å¿ƒæ€é€‰é¡¹å°†ç”±JSåŠ¨æ€å¡«å…… -->
                </div>
              </details>

              <!-- å‡¡äººæ ¹åŸº -->
              <details class="collapsible-section" open>
                <summary class="font-bold text-lg sm:text-xl mb-4 cursor-pointer">å‡¡äººæ ¹åŸº</summary>
                <div class="grid md:grid-cols-3 gap-4 mt-4">
                  <div class="card rounded-lg p-4 border border-green-700 bg-green-900/30">
                      <span class="font-semibold text-green-300">å›ºå®šèƒŒæ™¯ï¼šå†œå­¦ä¸–å®¶</span>
                      <p class="text-xs text-gray-400 mt-1">ä½ å‡ºèº«äºå†œä¸šä¸–å®¶ï¼Œå¯¹æ¤ç‰©çš„ä¹ æ€§æœ‰å¤©ç”Ÿçš„äº²å’ŒåŠ›ã€‚</p>
                  </div>
                  <div id="traits-container" class="md:col-span-2">
                    <!-- å¯é€‰ç‰¹é•¿å°†ç”±JSåŠ¨æ€å¡«å…… -->
                  </div>
                </div>
              </details>

              <!-- å±æ€§åˆ†é… -->
              <details class="collapsible-section" open>
                <summary class="font-bold text-lg sm:text-xl mb-4 cursor-pointer">
                  å¤©èµ‹åˆ†é… (å‰©ä½™å¤©èµ‹ç‚¹: <span id="points-talent-remaining" class="text-blue-400 font-bold">10</span> / <span class="text-gray-400">10</span>)
                </summary>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 md:gap-6 mt-4">
                  <!-- æ ¹éª¨ -->
                  <div class="card rounded-lg p-6">
                    <label for="talent-gen-gu" class="font-semibold text-gray-200 flex items-center justify-between">
                      <span><i class="fas fa-bone text-yellow-400 mr-2"></i>æ ¹éª¨</span>
                      <span id="talent-gen-gu-value" class="text-lg font-bold text-blue-400">0</span>
                    </label>
                    <p class="text-sm text-gray-400 mt-1 mb-3">å½±å“ä½ çš„ä¿®ç‚¼é€Ÿåº¦ä¸è‚‰èº«å¼ºåº¦ã€‚</p>
                    <input id="talent-gen-gu" type="range" min="0" max="10" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer talent-slider">
                  </div>
                  <!-- æ‚Ÿæ€§ -->
                  <div class="card rounded-lg p-6">
                    <label for="talent-wu-xing" class="font-semibold text-gray-200 flex items-center justify-between">
                      <span><i class="fas fa-brain text-purple-400 mr-2"></i>æ‚Ÿæ€§</span>
                      <span id="talent-wu-xing-value" class="text-lg font-bold text-blue-400">0</span>
                    </label>
                    <p class="text-sm text-gray-400 mt-1 mb-3">å†³å®šä½ é¢†æ‚ŸåŠŸæ³•ã€ç ´è§£ç¦åˆ¶çš„èƒ½åŠ›ã€‚</p>
                    <input id="talent-wu-xing" type="range" min="0" max="10" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer talent-slider">
                  </div>
                  <!-- æ°”è¿ -->
                  <div class="card rounded-lg p-6">
                    <label for="talent-qi-yun" class="font-semibold text-gray-200 flex items-center justify-between">
                      <span><i class="fas fa-clover text-green-400 mr-2"></i>æ°”è¿</span>
                      <span id="talent-qi-yun-value" class="text-lg font-bold text-blue-400">0</span>
                    </label>
                    <p class="text-sm text-gray-400 mt-1 mb-3">å½±å“ä½ é‡åˆ°å¥‡é‡ã€æ‹¾å–å®ç‰©çš„æ¦‚ç‡ã€‚</p>
                    <input id="talent-qi-yun" type="range" min="0" max="10" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer talent-slider">
                  </div>
                </div>
              </details>

              <!-- ç‰©å“é€‰æ‹© -->
              <details class="collapsible-section" open>
                <summary class="font-bold text-lg sm:text-xl mb-4 cursor-pointer">ç‰©å“é€‰æ‹©</summary>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 mt-4">
                  <!-- èƒŒåŒ…/ä»“åº“ (ä¿®ä»™ç‰©å“) -->
                  <div>
                    <h3 class="font-bold text-base mb-2">èƒŒåŒ…/ä»“åº“ (ä»™ç¼˜ç‚¹: <span id="points-inventory-remaining" class="text-green-400 font-bold">5</span> / <span class="text-gray-400">5</span>)</h3>
                    <div class="card rounded-lg p-4 sm:p-6">
                      <p class="text-sm text-gray-400 mt-1 mb-3">é€‰æ‹©ä½ åˆå§‹è·å¾—çš„ä¿®ä»™ç•Œç‰©å“ã€‚</p>
                      <div id="inventory-items-container" class="space-y-3 max-h-60 sm:max-h-72 overflow-y-auto pr-2">
                        <!-- ä¿®ä»™ç‰©å“å°†ç”±JSåŠ¨æ€å¡«å…… -->
                      </div>
                    </div>
                  </div>
                  
                  <!-- å¸†å¸ƒåŒ… (åœ°çƒç‰©å“) -->
                  <div>
                    <h3 class="font-bold text-base mb-2">å¸†å¸ƒåŒ… (é—ç‰©ç‚¹: <span id="points-bag-remaining" class="text-cyan-400 font-bold">5</span> / <span class="text-gray-400">5</span>)</h3>
                    <div class="card rounded-lg p-4 sm:p-6">
                      <p class="text-sm text-gray-400 mt-1 mb-3">é€‰æ‹©é¢å¤–çš„ä¸ªäººç‰©å“ã€‚åŒ…å†…é»˜è®¤å·²æœ‰ï¼š<span class="text-gray-300 font-semibold">æ²¡ç”µçš„æ‰‹æœºã€ä¸€å¥—æ¢æ´—è¡£ç‰©</span>ã€‚</p>
                      <div id="bag-items-container" class="space-y-3 max-h-60 sm:max-h-72 overflow-y-auto pr-2">
                        <!-- åœ°çƒç‰©å“å°†ç”±JSåŠ¨æ€å¡«å…… -->
                      </div>
                    </div>
                  </div>
                </div>
              </details>

              <!-- ç‚¹æ•°æ€»è§ˆ -->
              <div class="text-center p-4 card rounded-lg">
                <h3 class="font-bold text-lg">ç‚¹æ•°æ€»è§ˆ</h3>
                <p class="text-sm text-gray-400">æ‰€æœ‰è¶…å‡ºåŸºç¡€ç‚¹æ•°çš„æ¶ˆè€—ï¼Œå°†ä»ç¯å¢ƒæä¾›çš„ <span class="text-yellow-400">é¢å¤–ç‚¹æ•°</span> ä¸­æ‰£é™¤ã€‚</p>
                <p class="text-lg mt-2">å¯ç”¨é¢å¤–ç‚¹æ•°: <span id="points-extra-remaining" class="text-yellow-400 font-bold">0</span></p>
              </div>

              <!-- ç¡®è®¤æŒ‰é’® -->
              <div class="text-center flex justify-center items-center space-x-4">
                <button id="load-previous-button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                  <i class="fas fa-history mr-2"></i>è¯»å–ä¸Šæ¬¡
                </button>
                <button id="confirm-start-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 disabled:bg-gray-500 disabled:cursor-not-allowed">
                  <i class="fas fa-check-circle mr-2"></i>ç¡®è®¤å¼€å±€
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer class="text-center mb-16 prose-custom">
      <p class="mt-4 text-lg text-gray-400">å®Œæˆå¼€å±€è®¾å®šååˆ‡æ¢æ¶ˆæ¯é¡µä»¥å¼€å§‹æ¸¸ç©</p>
    </footer>
  </div>

<script>
// --- æ•°æ®å®šä¹‰ ---

const environments = [
    { id: 'env-easy', name: 'é£è°ƒé›¨é¡º', description: 'æµ·å²›æ°”å€™æ¸©å’Œï¼Œèµ„æºä¸°å¯Œï¼Œæ‹¥æœ‰ç¨³å®šçš„æ·¡æ°´å’Œé£Ÿç‰©æ¥æºã€‚', extraPoints: 0 },
    { id: 'env-medium', name: 'æš—æµæ¶ŒåŠ¨', description: 'å¤©æ°”å¤šå˜ï¼Œéƒ¨åˆ†æ°´æºè¢«æ±¡æŸ“ï¼Œä½ éœ€è¦èŠ±è´¹æ›´å¤šç²¾åŠ›å¯»æ‰¾é£Ÿç‰©ã€‚', extraPoints: 3 },
    { id: 'env-hard', name: 'ç»åœ°å¤©é€š', description: 'çµæ°”ç¨€è–„ä¸”ç‹‚æš´ï¼Œç”Ÿå­˜ç»´è‰°ï¼Œä½ ç”šè‡³ä¼šæŒç»­æ„Ÿåˆ°è™šå¼±ã€‚', extraPoints: 6 },
];

const mindsets = [
    { id: 'mindset-survivor', name: 'æ±‚ç”Ÿè€…', description: 'æ´»ä¸‹å»æ˜¯ä¸å˜çš„çœŸç†ã€‚ä½ å¯¹ç¯å¢ƒä¸­çš„å±é™©å’Œæœºé‡æœ‰æ›´å¼ºçš„ç›´è§‰ã€‚' },
    { id: 'mindset-explorer', name: 'æ¢ç©¶è€…', description: 'è§£æä¸–ç•Œæ˜¯æœ€å¤§çš„ä¹è¶£ã€‚ä½ æ›´å®¹æ˜“ä»æœªçŸ¥äº‹ç‰©ä¸­è·å¾—æ„Ÿæ‚Ÿã€‚' },
    { id: 'mindset-returner', name: 'å½’ä¹¡è€…', description: 'è¿™é‡Œåªæ˜¯å«è„šçŸ³ã€‚ä½ å¯¹ç©ºé—´ã€æ˜Ÿè¾°ç›¸å…³çš„çº¿ç´¢æœ‰ç‰¹æ®Šæ„Ÿåº”ã€‚' },
];

const defaultTrait = { id: 'trait-farmer', name: 'å†œå­¦ä¸–å®¶', description: 'ä½ å‡ºèº«äºå†œä¸šä¸–å®¶ï¼Œå¯¹æ¤ç‰©çš„ä¹ æ€§æœ‰å¤©ç”Ÿçš„äº²å’ŒåŠ›ã€‚' };
const optionalTraits = [
    { id: 'trait-athlete', name: 'è¿åŠ¨å¥å°†', description: 'ä½ æ›¾æ˜¯è¿åŠ¨å¥å°†ï¼Œæ‹¥æœ‰æ›´å¼ºçš„ä½“èƒ½å’Œè€åŠ›ã€‚' },
    { id: 'trait-handy', name: 'åŠ¨æ‰‹è¾¾äºº', description: 'ä½ çƒ­çˆ±æ‰‹å·¥ï¼Œèƒ½æ›´å¿«åœ°åˆ¶ä½œå’Œä¿®å¤å·¥å…·ã€‚' },
    { id: 'trait-none', name: 'æ— ', description: 'ä½ æ²¡æœ‰å…¶ä»–ç‰¹åˆ«çš„å‡¡äººç‰¹é•¿ã€‚' },
];

const inventoryItems = [
  { id: 'item-chang-chun-jue', name: 'ã€Šé•¿æ˜¥è¯€ã€‹æ‹“æœ¬', description: 'ä¸€éƒ¨å®Œæ•´çš„ç‚¼æ°”æœŸæœ¨ç³»åŠŸæ³•ï¼Œä¸­æ­£å¹³å’Œã€‚', points: 4 },
  { id: 'item-cao-mu-tu-jian', name: 'ã€Šå…ƒåˆè‰æœ¨å›¾é‰´ã€‹æ®‹æœ¬', description: 'è®°å½•äº†å¤§é‡æµ·æ»¨çµæ¤çš„å›¾é‰´ï¼Œçµæ¤å¸ˆçš„å®è´µå‚è€ƒã€‚', points: 3 },
  { id: 'item-pigu-dan', name: 'ä¸€ç“¶è¾Ÿè°·ä¸¹', description: 'åé¢—è£…ï¼Œè®©ä½ åœ¨å‰æœŸæ— éœ€ä¸ºé£Ÿç‰©å‘æ„ã€‚', points: 2 },
  { id: 'item-duan-jian', name: 'æ–­è£‚çš„é£å‰‘ï¼ˆå‰‘å°–ï¼‰', description: 'ç”±é’ç‰ç²¾é’¢åˆ¶æˆï¼Œå¯æ‰“é€ æˆé”‹åˆ©çš„å°åˆ€æˆ–ç®­å¤´ã€‚', points: 2 },
  { id: 'item-chu-wu-dai', name: 'å¤±æ•ˆçš„å‚¨ç‰©è¢‹', description: 'ç©ºé—´å·²å¤±ï¼Œä½†å¯ç ”ç©¶å…¶ç¬¦æ–‡ç»“æ„ï¼Œæœ‰ä¿®å¤çš„å¯èƒ½ã€‚', points: 2 },
];

const bagItems = [
  { id: 'item-solar-charger', name: 'å¤ªé˜³èƒ½å……ç”µå™¨', description: 'ä¸€å—æŠ˜å å¼å¤ªé˜³èƒ½å……ç”µæ¿ï¼Œæˆ–è®¸èƒ½è®©ä½ é‚£å—æ¿ç –é‡æ–°å¼€æœºã€‚', points: 5 },
  { id: 'item-multi-tool', name: 'å¤šåŠŸèƒ½å†›åˆ€', description: 'ç‘å£«å†›åˆ€ï¼Œé›†æˆäº†å°åˆ€ã€é”¯å­ã€å¼€ç½å™¨ç­‰å¤šç§å·¥å…·ã€‚', points: 3 },
  { id: 'item-antibiotics', name: 'å¹¿è°±æŠ—ç”Ÿç´ ', description: 'ä¸€å°ç“¶é˜¿è«è¥¿æ—ï¼Œç”¨äºç´§æ€¥æƒ…å†µä¸‹çš„æŠ—æ„ŸæŸ“æ²»ç–—ã€‚', points: 3 },
  { id: 'item-seeds', name: 'é«˜äº§ä½œç‰©ç§å­', description: 'ä¸€å°åŒ…ç²¾é€‰çš„æ‚äº¤æ°´ç¨»å’ŒåœŸè±†ç§å­ã€‚', points: 2 },
  { id: 'item-fire-starter', name: 'æ‰“ç«çŸ³', description: 'é•æ¡æ‰“ç«çŸ³ï¼Œåœ¨æ½®æ¹¿ç¯å¢ƒä¸‹ä¹Ÿèƒ½ç”Ÿç«ã€‚', points: 2 },
  { id: 'item-fish-line', name: 'é«˜å¼ºåº¦é±¼çº¿å’Œé±¼é’©', description: 'ä¸“ä¸šçš„é’“é±¼å·¥å…·ï¼Œè®©ä½ æ›´å®¹æ˜“è·å–é£Ÿç‰©ã€‚', points: 1 },
];

const defaultBagItems = ['æ²¡ç”µçš„æ‰‹æœº', 'ä¸€å¥—æ¢æ´—è¡£ç‰©'];

// --- Tab åŠŸèƒ½ ---
function showTab(tabId) {
  $('.tab-content, .tab-button').removeClass('active');
  $(`#${tabId}, [data-tab="${tabId}"]`).addClass('active');
}

function initializeTabs() {
  $('.tab-button').on('click', function() {
    const tabId = $(this).data('tab');
    if (tabId) showTab(tabId);
  });
}

// --- æ¸²æŸ“å‡½æ•° ---
function renderOptions(containerId, items, type, name, pointClass) {
    const container = $(`#${containerId}`);
    if (!container.length) return;
    let html = '';
    items.forEach((item, index) => {
        const hasPoints = item.points !== undefined || item.extraPoints !== undefined;
        const pointValue = item.points !== undefined ? `+${item.points}ç‚¹` : `+${item.extraPoints}é¢å¤–ç‚¹æ•°`;
        const pointText = hasPoints ? `<span class="${pointClass} font-bold">(${pointValue})</span>` : '';

        html += `
            <div class="card rounded-lg p-4 border border-gray-700 hover:border-purple-500 transition">
                <label for="${item.id}" class="flex items-start cursor-pointer">
                    <input type="${type}" id="${item.id}" name="${name}" value="${item.points || item.extraPoints || 0}" class="${name}-input mt-1 mr-3 h-4 w-4" ${type === 'radio' && index === 0 ? 'checked' : ''}>
                    <div>
                        <span class="font-semibold text-gray-200">${item.name}</span>
                        ${pointText}
                        <p class="text-xs text-gray-400 mt-1">${item.description}</p>
                    </div>
                </label>
            </div>`;
    });
    container.html(html);
}

function renderItems(containerId, items, itemClass) {
  const container = $(`#${containerId}`);
  if (!container.length) return;
  let html = '';
  items.forEach(item => {
    html += `
      <div class="item-card p-3 rounded-lg border border-gray-700 hover:border-blue-500 transition">
        <label for="${item.id}" class="flex items-start cursor-pointer">
          <input type="checkbox" id="${item.id}" data-points="${item.points}" class="${itemClass} mt-1 mr-3 h-4 w-4 rounded bg-gray-800 border-gray-600 text-blue-500 focus:ring-blue-600">
          <div>
            <span class="font-semibold text-gray-200">${item.name}</span>
            <span class="text-yellow-400 font-bold">(-${item.points}ç‚¹)</span>
            <p class="text-xs text-gray-400 mt-1">${item.description}</p>
          </div>
        </label>
      </div>`;
  });
  container.html(html);
}

// --- è‡ªå®šä¹‰å¼€å±€ä¸»é€»è¾‘ ---
function initializeCustomStart() {
  const UIElements = {
    sliders: $('.talent-slider'),
    confirmButton: $('#confirm-start-button'),
    loadPreviousButton: $('#load-previous-button'),
    points: {
      talentRemaining: $('#points-talent-remaining'),
      inventoryRemaining: $('#points-inventory-remaining'),
      bagRemaining: $('#points-bag-remaining'),
      extraRemaining: $('#points-extra-remaining'),
    },
  };

  const basePoints = { talent: 10, inventory: 5, bag: 5 };

  function updatePoints() {
    // 1. è®¡ç®—èŠ±è´¹
    let talentSpent = 0;
    UIElements.sliders.each(function() {
      const val = parseInt($(this).val(), 10);
      talentSpent += val;
      $(`#${this.id}-value`).text(val);
    });
    let inventorySpent = 0;
    $('.inventory-item-checkbox:checked').each(function() {
      inventorySpent += parseInt($(this).data('points'), 10);
    });
    let bagSpent = 0;
    $('.bag-item-checkbox:checked').each(function() {
      bagSpent += parseInt($(this).data('points'), 10);
    });

    // 2. è®¡ç®—å‰©ä½™ä¸è¶…æ”¯
    const talentLeft = basePoints.talent - talentSpent;
    const inventoryLeft = basePoints.inventory - inventorySpent;
    const bagLeft = basePoints.bag - bagSpent;
    
    // 3. è·å–é¢å¤–ç‚¹æ•°
    const extraPoints = parseInt($('input[name="environment"]:checked').val(), 10);
    const totalOverdraft = Math.max(0, -talentLeft) + Math.max(0, -inventoryLeft) + Math.max(0, -bagLeft);
    const finalExtraLeft = extraPoints - totalOverdraft;

    // 4. æ›´æ–°UI
    UIElements.points.talentRemaining.text(talentLeft);
    UIElements.points.inventoryRemaining.text(inventoryLeft);
    UIElements.points.bagRemaining.text(bagLeft);
    UIElements.points.extraRemaining.text(finalExtraLeft);

    // 5. å¤„ç†UIè­¦å‘Šå’ŒæŒ‰é’®çŠ¶æ€
    $('.font-bold').removeClass('text-red-500');
    if (finalExtraLeft < 0) {
      UIElements.confirmButton.prop('disabled', true);
      UIElements.points.extraRemaining.addClass('text-red-500');
      if (talentLeft < 0) UIElements.points.talentRemaining.addClass('text-red-500');
      if (inventoryLeft < 0) UIElements.points.inventoryRemaining.addClass('text-red-500');
      if (bagLeft < 0) UIElements.points.bagRemaining.addClass('text-red-500');
    } else {
      UIElements.confirmButton.prop('disabled', false);
    }
  }

  // åˆå§‹åŒ–æ¸²æŸ“
  renderOptions('environments-container', environments, 'radio', 'environment', 'text-yellow-400');
  renderOptions('mindsets-container', mindsets, 'radio', 'mindset', 'text-gray-500');
  renderOptions('traits-container', optionalTraits, 'radio', 'trait', 'text-gray-500');
  renderItems('inventory-items-container', inventoryItems, 'inventory-item-checkbox');
  renderItems('bag-items-container', bagItems, 'bag-item-checkbox');
  
  // ç»‘å®šäº‹ä»¶
  $('input').on('change input', updatePoints);

  // --- è¯»å–ä¸Šæ¬¡è®¾å®š ---
  async function loadPreviousSettings() {
    const bookName = "ä»€ä¹ˆï¼Ÿæˆ‘è¦åœ¨ç„å¹»ä¿®ä»™ä¸–ç•Œç§ç”°ï¼Ÿ";
    const entryKey = "è‡ªå®šä¹‰å¼€å±€";
    toastr.info('æ­£åœ¨è¯»å–ä¸Šæ¬¡çš„å¼€å±€è®¾å®š...');

    try {
      const worldbook = await getWorldbook(bookName);
      const entry = worldbook.find(e => e.name === entryKey);
      const worldbookContent = entry?.content;

      if (worldbookContent) {
        parseAndApplySettings(worldbookContent);
        updatePoints(); // æ›´æ–°ç‚¹æ•°æ˜¾ç¤º
        toastr.success('å·²æˆåŠŸåŠ è½½ä¸Šæ¬¡çš„å¼€å±€è®¾å®šï¼');
        //console.log("å·²æˆåŠŸåŠ è½½ä¸Šæ¬¡çš„å¼€å±€è®¾å®š:",worldbookContent);
      } else {
        toastr.warning('æœªæ‰¾åˆ°ä¸Šæ¬¡çš„å¼€å±€è®¾å®šã€‚');
      }
    } catch (error) {
      console.error('è¯»å–ä¸–ç•Œä¹¦å¤±è´¥:', error);
      toastr.error('è¯»å–è®¾å®šå¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚');
    }
  }

  function parseAndApplySettings(content) {
    const getVal = (regex) => content.match(regex)?.[1].trim() || null;

    // ç¯å¢ƒ
    const envName = getVal(/- \*\*ã€ç¯å¢ƒã€‘(.*?)\*\*:/);
    const envData = environments.find(e => e.name === envName);
    if (envData) $(`#${envData.id}`).prop('checked', true);

    // å¿ƒæ€
    const mindsetName = getVal(/- \*\*ã€å¿ƒæ€ã€‘(.*?)\*\*:/);
    const mindsetData = mindsets.find(m => m.name === mindsetName);
    if (mindsetData) $(`#${mindsetData.id}`).prop('checked', true);

    // å¤©èµ‹
    const genGu = getVal(/-\s*\*\*æ ¹éª¨\*\*:\s*(\d+)\/10/);
    const wuXing = getVal(/-\s*\*\*æ‚Ÿæ€§\*\*:\s*(\d+)\/10/);
    const qiYun = getVal(/-\s*\*\*æ°”è¿\*\*:\s*(\d+)\/10/);
    if (genGu) {
      $('#talent-gen-gu').val(genGu);
      $('#talent-gen-gu-value').text(genGu);
    }
    if (wuXing) {
      $('#talent-wu-xing').val(wuXing);
      $('#talent-wu-xing-value').text(wuXing);
    }
    if (qiYun) {
      $('#talent-qi-yun').val(qiYun);
      $('#talent-qi-yun-value').text(qiYun);
    }

    // ç‰¹é•¿
    const traitsBlock = getVal(/- \*\*ã€å‡¡äººç‰¹é•¿ã€‘\*\*:\s*([\s\S]*?)(?=\n\s*- \*\*ã€ä¿®ä»™å¤©èµ‹ã€‘|$)/);
    const selectedTrait = optionalTraits.find(t => traitsBlock?.includes(`**${t.name}**`));
    $(`input[name="trait"]`).prop('checked', false);
    if (selectedTrait && selectedTrait.id !== 'trait-none') {
      $(`#${selectedTrait.id}`).prop('checked', true);
    } else {
      $('#trait-none').prop('checked', true);
    }

    // ç‰©å“
    const inventoryBlock = getVal(/- \*\*ã€ä¿®ä»™è€…è¡Œå›Šã€‘\*\*:\s*([\s\S]*?)(?=\n- \*\*ã€ç©¿è¶Šè€…å¸†å¸ƒåŒ…ã€‘|$)/);
    const bagBlock = getVal(/- \*\*ã€ç©¿è¶Šè€…å¸†å¸ƒåŒ…ã€‘\*\*:\s*([\s\S]*)/);

    $('.inventory-item-checkbox, .bag-item-checkbox').prop('checked', false);
    inventoryItems.forEach(item => {
      if (inventoryBlock?.includes(`**${item.name}**`)) $(`#${item.id}`).prop('checked', true);
    });
    bagItems.forEach(item => {
      if (bagBlock?.includes(`**${item.name}**`)) $(`#${item.id}`).prop('checked', true);
    });
  }

  UIElements.loadPreviousButton.on('click', loadPreviousSettings);

  // ç¡®è®¤æŒ‰é’®é€»è¾‘
  UIElements.confirmButton.on('click', async () => {
    updatePoints();
    if (UIElements.confirmButton.is(':disabled')) {
      toastr.error('ç‚¹æ•°åˆ†é…è¶…å‡ºä¸Šé™ï¼');
      return;
    }

    const getSelectionData = (selector, collection) => {
      const selectedId = $(selector).attr('id');
      return collection.find(item => item.id === selectedId) || null;
    };
    const getSelectionsData = (selector, collection) => {
      const selectedIds = $(selector).map((_, el) => $(el).attr('id')).get();
      return collection.filter(item => selectedIds.includes(item.id));
    };

    const selectedEnv = getSelectionData('input[name="environment"]:checked', environments);
    const selectedMindset = getSelectionData('input[name="mindset"]:checked', mindsets);
    const selectedTrait = getSelectionData('input[name="trait"]:checked', optionalTraits);

    const finalTraits = [defaultTrait];
    if (selectedTrait && selectedTrait.id !== 'trait-none') {
        finalTraits.push(selectedTrait);
    }

    const selections = {
      env: selectedEnv,
      mindset: selectedMindset,
      traits: finalTraits,
      talents: {
        genGu: $('#talent-gen-gu').val(),
        wuXing: $('#talent-wu-xing').val(),
        qiYun: $('#talent-qi-yun').val(),
      },
      inventory: getSelectionsData('.inventory-item-checkbox:checked', inventoryItems),
      bag: getSelectionsData('.bag-item-checkbox:checked', bagItems),
    };

    // æ„å»ºæ›´è¯¦ç»†ã€ç»“æ„åŒ–çš„æ¡ç›®å†…å®¹
    let entryContent = `
# ç©å®¶è‡ªå®šä¹‰å¼€å±€è®¾å®š
ä»¥ä¸‹æ˜¯ç©å®¶ä¸ºæœ¬æ¬¡æ¸¸æˆé€‰æ‹©çš„åˆå§‹é…ç½®ï¼Œè¯·åœ¨åç»­çš„å‰§æƒ…ç”Ÿæˆä¸­ä¸¥æ ¼å‚è€ƒè¿™äº›è®¾å®šã€‚

## æ ¸å¿ƒè®¾å®š
- **ã€ç¯å¢ƒã€‘${selections.env?.name}**: ${selections.env?.description}
- **ã€å¿ƒæ€ã€‘${selections.mindset?.name}**: ${selections.mindset?.description}

## å¤©èµ‹æ ¹åŸº
- **ã€å‡¡äººç‰¹é•¿ã€‘**: 
${selections.traits.map(t => `  - **${t.name}**: ${t.description}`).join('\n')}
- **ã€ä¿®ä»™å¤©èµ‹ã€‘**:
  - **æ ¹éª¨**: ${selections.talents.genGu}/10
  - **æ‚Ÿæ€§**: ${selections.talents.wuXing}/10
  - **æ°”è¿**: ${selections.talents.qiYun}/10

## åˆå§‹æºå¸¦
- **ã€ä¿®ä»™è€…è¡Œå›Šã€‘**:
${selections.inventory.length > 0 ? selections.inventory.map(item => `  - **${item.name}**: ${item.description}`).join('\n') : '  - æ— '}
- **ã€ç©¿è¶Šè€…å¸†å¸ƒåŒ…ã€‘**:
${[...defaultBagItems.map(name => `  - ${name}`), ...selections.bag.map(item => `  - **${item.name}**: ${item.description}`)].join('\n')}
`.trim();

    const bookName = "ä»€ä¹ˆï¼Ÿæˆ‘è¦åœ¨ç„å¹»ä¿®ä»™ä¸–ç•Œç§ç”°ï¼Ÿ";
    const entryKey = "è‡ªå®šä¹‰å¼€å±€";

    try {
      await updateWorldbookWith(bookName, (worldbook) => {
        const entryIndex = worldbook.findIndex(entry => entry.name === entryKey);

        if (entryIndex !== -1) {
          // æ›´æ–°ç°æœ‰æ¡ç›®
          worldbook[entryIndex].content = entryContent;
          toastr.success('è‡ªå®šä¹‰å¼€å±€å·²æ›´æ–°ï¼', 'è®¾ç½®å·²ä¿å­˜');
        } else {
          // åˆ›å»ºæ–°æ¡ç›®
          worldbook.push({
            name: entryKey,
            content: entryContent,
            enabled: true,
            strategy: {
              type: 'constant',
              keys: [],
              keys_secondary: { logic: 'and_any', keys: [] },
              scan_depth: 'same_as_global',
            },
            position: {
              type: 'before_character_definition',
              role: 'system',
              depth: 4,
              order: 0,
            },
            probability: 100,
            recursion: {
              prevent_incoming: false,
              prevent_outgoing: false,
              delay_until: null,
            },
            effect: {
              sticky: null,
              cooldown: null,
              delay: null,
            },
          });
          toastr.success('è‡ªå®šä¹‰å¼€å±€æˆåŠŸï¼', 'è®¾ç½®å·²ä¿å­˜');
        }
        return worldbook;
      });

      UIElements.confirmButton.text('å·²ç¡®è®¤').prop('disabled', true);
      $('input').prop('disabled', true);

      // Call the new function to update the first message's second swipe
      await updateFirstMessageSwipeWithItems(entryContent);

    } catch (error) {
      console.error('æ“ä½œä¸–ç•Œä¹¦æ¡ç›®æˆ–æ›´æ–°é¦–æ¥¼æ¶ˆæ¯å¤±è´¥:', error);
      toastr.error('è‡ªå®šä¹‰å¼€å±€å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ã€‚', 'é”™è¯¯');
    }
  });

  updatePoints(); // åˆå§‹è®¡ç®—
}

// DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
$(() => {
  initializeTabs();
  initializeCustomStart();

  // On mobile, close all collapsible sections by default
  if (window.innerWidth < 768) {
    $('.collapsible-section').removeAttr('open');
  }
});

async function updateFirstMessageSwipeWithItems(worldbookContent) {
  try {
    // 1. ä»ä¸–ç•Œä¹¦å†…å®¹ä¸­è§£æç‰©å“
    const inventoryRegex = /-\s\*\*ã€ä¿®ä»™è€…è¡Œå›Šã€‘\*\*:\s*([\s\S]*?)(?=\n- \*\*ã€ç©¿è¶Šè€…å¸†å¸ƒåŒ…ã€‘\*\*|$)/;
    const bagRegex = /-\s\*\*ã€ç©¿è¶Šè€…å¸†å¸ƒåŒ…ã€‘\*\*:\s*([\s\S]*)/;

    const inventoryMatch = worldbookContent.match(inventoryRegex);
    const bagMatch = worldbookContent.match(bagRegex);

    const parseSelectedItems = (match) => {
      if (!match || !match[1] || match[1].trim().includes('æ— ')) return [];
      return match[1]
        .split('\n')
        .map(line => line.trim())
        .filter(line => line.startsWith('- **')) // åªåŒ¹é…ç©å®¶é€‰æ‹©çš„åŠ ç²—é¡¹ç›®
        .map(line => {
            let itemName = line.replace(/^- \*\*/, '').split('**:')[0].trim();
            return `ğŸ’ ${itemName}`;
        });
    };

    const inventoryItems = parseSelectedItems(inventoryMatch);

    // ä»æ—…è¡ŒåŒ…éƒ¨åˆ†è§£ææ‰€æœ‰ç‰©å“ï¼ˆåŒ…æ‹¬é»˜è®¤å’Œé€‰æ‹©çš„ï¼‰
    const allBagItems = [];
    if (bagMatch && bagMatch[1]) {
      const itemLines = bagMatch[1].split('\n').map(line => line.trim()).filter(line => line.startsWith('- '));
      for (const line of itemLines) {
        if (line.startsWith('- **')) {
          // ç©å®¶é€‰æ‹©çš„ç‰©å“
          const itemName = line.replace(/^- \*\*/, '').split('**:')[0].trim();
          allBagItems.push(`ğŸ’ ${itemName}`);
        } else {
          // é»˜è®¤ç‰©å“
          const itemName = line.replace(/^-/, '').trim();
          allBagItems.push(`ğŸ’ - ${itemName}`);
        }
      }
    }

    // 2. æ„å»ºæ–°çš„ã€ç»“æ„æ­£ç¡®çš„ç‰©å“åˆ—è¡¨
    const allItems = [
      ...inventoryItems,
      'ğŸ‘œ ã€ç©¿è¶Šè€…å¸†å¸ƒåŒ…ã€‘',
      ...allBagItems,
    ];

    // 2. è·å–é¦–æ¥¼çš„æ‰€æœ‰æ¶ˆæ¯é¡µ
    const firstMessageSwipes = getChatMessages(0, { include_swipes: true })[0];
    if (!firstMessageSwipes || !firstMessageSwipes.swipes || firstMessageSwipes.swipes.length < 2) {
      toastr.error('æ— æ³•è·å–åˆ°é¦–æ¥¼çš„ç¬¬äºŒä¸ªæ¶ˆæ¯é¡µï¼ˆæ¸¸æˆå¼€å±€é¡µï¼‰ã€‚');
      return;
    }

    const gameStartSwipeContent = firstMessageSwipes.swipes[1];

    // 3. ä½¿ç”¨ jQuery è§£æç¬¬äºŒä¸ªæ¶ˆæ¯é¡µçš„HTMLå†…å®¹
    const $parsedContent = $(`<div>${gameStartSwipeContent}</div>`);
    const $statusBar = $parsedContent.find('statusbar'); // jQuery is case-insensitive for tag names

    if ($statusBar.length === 0) {
        toastr.error('æ¸¸æˆå¼€å±€é¡µä¸­æœªæ‰¾åˆ° <statusbar> æ ‡ç­¾ã€‚');
        return;
    }
    const statusBarJsonContent = $statusBar.text().trim();

    let statusBarData;
    try {
      statusBarData = JSON.parse(statusBarJsonContent);
    } catch (e) {
      toastr.error('è§£ææ¸¸æˆå¼€å±€é¡µä¸­ <statusbar> å†…çš„JSONå¤±è´¥ã€‚');
      console.error("JSON Parsing Error:", e, "Content:", statusBarJsonContent);
      return;
    }

    // 4. æ›´æ–°æ ¸å¿ƒç‰©å“ (ä½¿ç”¨æ›´ç¨³å¥çš„æŸ¥æ‰¾æ–¹å¼)
    const rootKey = Object.keys(statusBarData)[0];
    const characterList = statusBarData[rootKey]['è§’è‰²åˆ—è¡¨'];
    if (characterList && Array.isArray(characterList) && characterList.length > 0) {
        const mainCharacter = characterList[0]['ğŸ‘¤ è§’è‰²'];
        if (mainCharacter) {
            mainCharacter['ğŸ’ æ ¸å¿ƒç‰©å“'] = allItems;
        }
    }

    // 5. æ„å»ºæ–°çš„æ¶ˆæ¯é¡µæ•°ç»„å¹¶ä¿å­˜
    const updatedJsonString = JSON.stringify(statusBarData, null, 2);
    const updatedSwipeContent = gameStartSwipeContent.replace(statusBarRegex, `<StatusBar>\n${updatedJsonString}\n</StatusBar>`);

    const newSwipes = [...firstMessageSwipes.swipes];
    newSwipes[1] = updatedSwipeContent;

    await setChatMessages([{ message_id: 0, swipes: newSwipes }], { refresh: 'none' });

    toastr.success('å·²æˆåŠŸæ›´æ–°æ¸¸æˆå¼€å±€çš„æ ¸å¿ƒç‰©å“ï¼');

  } catch (error) {
    console.error('æ›´æ–°æ¸¸æˆå¼€å±€æ¶ˆæ¯å¤±è´¥:', error);
    toastr.error('æ›´æ–°æ¸¸æˆå¼€å±€çŠ¶æ€å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚');
  }
}
</script>
</body>
